<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pocket Pal: Deluxe</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap');

        :root {
            --primary: #6c5ce7;
            --accent: #00b894;
            --warn: #e17055;
            --bg: #dfe6e9;
            --glass: rgba(255, 255, 255, 0.8);
        }

        body {
            margin: 0; overflow: hidden; background: #2d3436;
            font-family: 'Fredoka', sans-serif;
            touch-action: none; user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        canvas { display: block; width: 100%; height: 100%; }

        /* UI LAYER */
        #ui {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: flex; flex-direction: column;
            justify-content: space-between; z-index: 10;
        }

        /* HUD */
        .hud {
            padding: 20px; display: flex; justify-content: space-between; align-items: flex-start;
            pointer-events: auto;
        }

        .stats-box {
            background: var(--glass); padding: 12px 18px; border-radius: 25px;
            backdrop-filter: blur(12px); box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; gap: 8px; width: 130px;
            transition: transform 0.2s;
        }
        .stats-box:active { transform: scale(0.98); }

        .stat-row { display: flex; align-items: center; gap: 8px; }
        .stat-icon { font-size: 16px; width: 20px; }
        .bar-track { flex: 1; height: 8px; background: rgba(0,0,0,0.1); border-radius: 10px; overflow: hidden; }
        .bar-fill { height: 100%; border-radius: 10px; transition: width 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); }

        .coin-pill {
            background: linear-gradient(135deg, #f1c40f, #f39c12);
            color: white; padding: 10px 24px; border-radius: 50px;
            font-size: 20px; font-weight: 700; display: flex; align-items: center; gap: 8px;
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.4); text-shadow: 0 2px 0 rgba(0,0,0,0.2);
        }

        /* DOCK */
        .dock {
            padding: 30px; display: flex; justify-content: center; gap: 20px;
            pointer-events: auto; background: linear-gradient(to top, rgba(0,0,0,0.4), transparent);
        }

        .btn {
            width: 70px; height: 70px; border-radius: 24px;
            background: white; border: none; font-size: 32px;
            box-shadow: 0 8px 0 #b2bec3, 0 15px 25px rgba(0,0,0,0.2);
            cursor: pointer; position: relative; transition: all 0.1s;
        }
        .btn:active { transform: translateY(8px); box-shadow: 0 0 0 #b2bec3, 0 0 0 rgba(0,0,0,0); }
        .btn::after {
            content: attr(data-label); position: absolute; bottom: 4px; left:0; width:100%;
            font-size: 10px; font-weight: 700; color: #636e72;
        }

        #mic-btn {
            width: 85px; height: 85px; border-radius: 50%;
            background: var(--primary); color: white; margin-top: -20px;
            box-shadow: 0 10px 0 #4834d4, 0 20px 40px rgba(108, 92, 231, 0.5);
        }
        #mic-btn.recording { background: #ff4757; box-shadow: 0 10px 0 #c0392b; animation: pulse 1s infinite; }

        /* MODALS */
        .modal {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(8px);
            z-index: 100; display: none; align-items: center; justify-content: center;
            pointer-events: auto;
        }
        .modal-card {
            background: white; width: 90%; max-width: 450px; border-radius: 30px;
            padding: 30px; text-align: center; position: relative;
            animation: popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 20px; }
        .card {
            background: #f1f2f6; padding: 15px; border-radius: 20px; cursor: pointer;
            border: 3px solid transparent; transition: 0.2s;
        }
        .card:active { transform: scale(0.95); }
        .card.selected { border-color: var(--accent); background: #e0fbf6; }

        /* RHYTHM GAME UI */
        #game-ui {
            position: absolute; top:0; left:0; width:100%; height:100%;
            z-index: 50; display: none; flex-direction: column; align-items: center;
            background: linear-gradient(135deg, #2d3436, #000); pointer-events: auto;
        }
        .hit-zone {
            position: absolute; bottom: 50px; width: 100%; display: flex; justify-content: space-around;
        }
        .hit-btn {
            width: 80px; height: 80px; border-radius: 50%; border: 4px solid white;
            background: transparent; color: white; font-weight: bold; font-size: 24px;
            display: flex; align-items: center; justify-content: center;
        }
        .hit-btn:active { background: white; color: black; }

        /* DRAG GHOST */
        #ghost {
            position: fixed; font-size: 60px; pointer-events: none; z-index: 200;
            display: none; transform: translate(-50%, -50%); filter: drop-shadow(0 10px 10px rgba(0,0,0,0.3));
        }

        /* TOAST */
        .toast {
            position: fixed; top: 15%; left: 50%; transform: translateX(-50%);
            background: #2d3436; color: white; padding: 12px 25px; border-radius: 50px;
            opacity: 0; pointer-events: none; transition: 0.3s; z-index: 300; font-weight: 600;
        }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.8); } 100% { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body>

<canvas id="cvs"></canvas>

<div id="ui">
    <div class="hud">
        <div class="stats-box">
            <div class="stat-row"><span class="stat-icon">üçó</span><div class="bar-track"><div class="bar-fill" id="bar-food" style="background:#ff7675"></div></div></div>
            <div class="stat-row"><span class="stat-icon">üßº</span><div class="bar-track"><div class="bar-fill" id="bar-clean" style="background:#74b9ff"></div></div></div>
            <div class="stat-row"><span class="stat-icon">‚ö°</span><div class="bar-track"><div class="bar-fill" id="bar-energy" style="background:#fdcb6e"></div></div></div>
        </div>
        
        <div class="coin-pill">ü™ô <span id="coin-txt">0</span></div>
        
        <button class="btn" style="width:55px; height:55px; font-size:24px;" onclick="UI.openShop()">üõçÔ∏è</button>
    </div>

    <div class="dock">
        <button class="btn" data-label="FEED" onpointerdown="Input.startDrag('food', event)">üçî</button>
        <button class="btn" data-label="WASH" onpointerdown="Input.startDrag('sponge', event)">üßº</button>
        <button class="btn" id="mic-btn" onpointerdown="AudioSys.record()" onpointerup="AudioSys.stop()">üéôÔ∏è</button>
        <button class="btn" data-label="SLEEP" onclick="Game.toggleSleep()">üí°</button>
        <button class="btn" data-label="PLAY" onclick="RhythmGame.start()">üé∏</button>
    </div>
</div>

<!-- GHOST -->
<div id="ghost"></div>
<!-- TOAST -->
<div id="toast">Saved!</div>

<!-- SHOP -->
<div id="modal-shop" class="modal">
    <div class="modal-card">
        <div style="display:flex; justify-content:space-between; align-items:center">
            <h2 style="margin:0">Boutique</h2>
            <button class="btn" style="width:40px; height:40px; font-size:18px;" onclick="UI.close()">‚úï</button>
        </div>
        <div class="grid">
            <div class="card" onclick="Game.buy('hat', 150)">
                <div style="font-size:35px">üß¢</div>
                <b>Snapback</b><br><small>150 ü™ô</small>
            </div>
            <div class="card" onclick="Game.buy('glasses', 200)">
                <div style="font-size:35px">üï∂Ô∏è</div>
                <b>Aviators</b><br><small>200 ü™ô</small>
            </div>
            <div class="card" onclick="Game.buy('bowtie', 100)">
                <div style="font-size:35px">üéÄ</div>
                <b>Bowtie</b><br><small>100 ü™ô</small>
            </div>
            <div class="card" onclick="Game.buy('potion', 50)">
                <div style="font-size:35px">üß™</div>
                <b>Energy Max</b><br><small>50 ü™ô</small>
            </div>
        </div>
    </div>
</div>

<!-- RHYTHM GAME -->
<div id="game-ui">
    <div style="margin-top:20px; color:white; font-size:24px;">BEAT DOGGY</div>
    <div style="font-size:40px; color:#f1c40f; font-weight:bold" id="rhythm-score">0</div>
    <button class="btn" style="position:absolute; top:20px; right:20px; width:50px; height:50px; font-size:20px;" onclick="RhythmGame.stop()">‚úï</button>
    
    <div class="hit-zone">
        <div class="hit-btn" onpointerdown="RhythmGame.hit(0)">L</div>
        <div class="hit-btn" onpointerdown="RhythmGame.hit(1)">R</div>
    </div>
</div>

<script>
    /** AUDIO SYSTEM (Pitch Shifter) **/
    const AudioSys = {
        ctx: new (window.AudioContext || window.webkitAudioContext)(),
        rec: null, chunks: [],
        init() { if(this.ctx.state==='suspended') this.ctx.resume(); },
        
        sfx(t) {
            this.init();
            const o=this.ctx.createOscillator(), g=this.ctx.createGain();
            o.connect(g); g.connect(this.ctx.destination);
            const n=this.ctx.currentTime;
            
            if(t==='coin'){
                o.type='sine'; o.frequency.setValueAtTime(1000,n); o.frequency.linearRampToValueAtTime(1500,n+0.1);
                g.gain.setValueAtTime(0.1,n); g.gain.linearRampToValueAtTime(0,n+0.2);
                o.start(); o.stop(n+0.2);
            } else if(t==='pop'){
                o.type='triangle'; o.frequency.setValueAtTime(600,n); o.frequency.exponentialRampToValueAtTime(100,n+0.15);
                g.gain.setValueAtTime(0.1,n); g.gain.exponentialRampToValueAtTime(0.01,n+0.15);
                o.start(); o.stop(n+0.15);
            }
        },

        async record() {
            try {
                this.init();
                const stream = await navigator.mediaDevices.getUserMedia({audio:true});
                this.rec = new MediaRecorder(stream);
                this.chunks=[];
                this.rec.ondataavailable=e=>this.chunks.push(e.data);
                this.rec.start();
                document.getElementById('mic-btn').classList.add('recording');
                Game.dog.anim='listen';
            } catch(e) { UI.toast("Microphone Access Required"); }
        },

        stop() {
            if(!this.rec || this.rec.state==='inactive') return;
            this.rec.stop();
            document.getElementById('mic-btn').classList.remove('recording');
            this.rec.onstop = async () => {
                const blob = new Blob(this.chunks,{type:'audio/ogg; codecs=opus'});
                const ab = await blob.arrayBuffer();
                const buf = await this.ctx.decodeAudioData(ab);
                const src = this.ctx.createBufferSource();
                src.buffer=buf; src.playbackRate.value=1.4; // Chipmunk effect
                src.connect(this.ctx.destination);
                src.start();
                Game.dog.anim='talk';
                src.onended=()=>Game.dog.anim='idle';
            };
        }
    };

    /** GAME ENGINE **/
    const cvs = document.getElementById('cvs');
    const ctx = cvs.getContext('2d');
    let W, H;

    const Game = {
        state: 'HOME', // HOME, RHYTHM
        coins: 100,
        needs: { food:80, clean:80, energy:90 },
        inv: { hat:false, glasses:false, bowtie:false },
        dark: false,
        time: 0,
        particles: [],

        dog: {
            x:0, y:0, scaleY:1,
            anim: 'idle',
            look: {x:0,y:0},
            blinkTimer: 0
        },

        init() {
            this.resize();
            window.addEventListener('resize', ()=>this.resize());
            this.load();
            this.loop();
            setInterval(()=>this.logic(), 1000);
            setInterval(()=>this.save(), 5000);
        },

        resize() {
            W=window.innerWidth; H=window.innerHeight;
            cvs.width=W*devicePixelRatio; cvs.height=H*devicePixelRatio;
            ctx.scale(devicePixelRatio, devicePixelRatio);
            this.dog.x=W/2; this.dog.y=H/2+80;
        },

        save() {
            localStorage.setItem('pocketPalDeluxe', JSON.stringify({
                coins: this.coins, needs: this.needs, inv: this.inv
            }));
        },

        load() {
            const d = JSON.parse(localStorage.getItem('pocketPalDeluxe'));
            if(d) {
                this.coins = d.coins || 100;
                this.needs = d.needs || {food:80, clean:80, energy:80};
                this.inv = d.inv || {};
            }
        },

        logic() {
            if(this.state!=='HOME') return;
            this.time += 0.01;
            
            if(this.dark) {
                this.needs.energy = Math.min(100, this.needs.energy+2);
            } else {
                this.needs.energy = Math.max(0, this.needs.energy-0.2);
                this.needs.food = Math.max(0, this.needs.food-0.5);
                this.needs.clean = Math.max(0, this.needs.clean-0.3);
            }
            UI.update();
        },

        toggleSleep() {
            this.dark = !this.dark;
            this.dog.anim = this.dark ? 'sleep' : 'idle';
        },

        buy(item, price) {
            if(item==='potion') {
                if(this.coins>=price){ this.coins-=price; this.needs.energy=100; UI.toast("Energized!"); }
                return;
            }
            if(this.coins>=price && !this.inv[item]) {
                this.coins-=price; this.inv[item]=true; UI.toast("Purchased!");
                UI.update();
            } else UI.toast("Cannot Buy");
        },

        loop() {
            ctx.clearRect(0,0,W,H);
            
            if(this.state==='HOME') {
                this.drawRoom();
                this.drawDog();
                this.drawParticles();
            } else {
                RhythmGame.loop();
            }
            requestAnimationFrame(()=>this.loop());
        },

        drawRoom() {
            // Dynamic Background
            const bgGradient = ctx.createLinearGradient(0,0,0,H);
            if(this.dark) {
                bgGradient.addColorStop(0, '#2d3436'); bgGradient.addColorStop(1, '#000000');
            } else {
                bgGradient.addColorStop(0, '#74b9ff'); bgGradient.addColorStop(1, '#a29bfe');
            }
            ctx.fillStyle = bgGradient;
            ctx.fillRect(0,0,W,H);

            // Floor (Perspective)
            ctx.fillStyle = this.dark ? '#111' : '#ecf0f1';
            ctx.beginPath(); ctx.ellipse(W/2, H, W*1.2, 300, 0,0,Math.PI*2); ctx.fill();

            // Clouds / Stars
            ctx.fillStyle = 'rgba(255,255,255,0.2)';
            if(this.dark) {
                for(let i=0;i<10;i++) {
                    ctx.beginPath(); ctx.arc((i*100)%W, 50+(i*20)%100, 2, 0, Math.PI*2); ctx.fill();
                }
            } else {
                ctx.beginPath(); ctx.arc(100 + Math.sin(this.time)*20, 100, 40, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(140 + Math.sin(this.time)*20, 100, 50, 0, Math.PI*2); ctx.fill();
            }
        },

        drawDog() {
            const d = this.dog;
            const dark = this.dark;

            // Breathing Physics
            const breath = Math.sin(Date.now()/800)*4;
            let sy = d.scaleY + (breath*0.003);
            
            ctx.save();
            ctx.translate(d.x, d.y);
            ctx.scale(1, sy);

            // Shadow
            ctx.fillStyle = 'rgba(0,0,0,0.2)';
            ctx.beginPath(); ctx.ellipse(0, 95, 70, 15, 0,0,Math.PI*2); ctx.fill();

            // Tail Wag Physics
            if(d.anim!=='sleep') {
                const happy = (this.needs.food+this.needs.clean)/2 > 50;
                const wagSpeed = happy ? 50 : 200;
                const wagAmp = happy ? 20 : 5;
                const wag = Math.sin(Date.now()/wagSpeed)*wagAmp;
                
                ctx.strokeStyle = '#b2bec3'; ctx.lineWidth=15; ctx.lineCap='round';
                ctx.beginPath(); ctx.moveTo(40,60); ctx.quadraticCurveTo(70,50, 80,10+wag); ctx.stroke();
            }

            // Body (3D Gradient)
            const bodyGrad = ctx.createRadialGradient(-20,-20, 10, 0,0, 80);
            bodyGrad.addColorStop(0, dark?'#636e72':'#fff'); bodyGrad.addColorStop(1, dark?'#2d3436':'#bdc3c7');
            ctx.fillStyle = bodyGrad;
            
            ctx.beginPath();
            ctx.moveTo(-45, 80); ctx.quadraticCurveTo(-70, 80, -60, -20);
            ctx.lineTo(60, -20); ctx.quadraticCurveTo(70, 80, 45, 80);
            ctx.fill();

            // Belly
            ctx.fillStyle = dark?'#555':'#fff';
            ctx.beginPath(); ctx.ellipse(0, 40, 30, 45, 0,0,Math.PI*2); ctx.fill();

            // Head Bob
            ctx.translate(0, -60+breath);
            
            // Ears
            ctx.fillStyle = dark?'#2d3436':'#b2bec3';
            ctx.beginPath(); ctx.ellipse(-50, 0, 18, 45, 0.2, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.ellipse(50, 0, 18, 45, -0.2, 0, Math.PI*2); ctx.fill();

            // Head Shape
            const headGrad = ctx.createRadialGradient(0,0,10,0,0,70);
            headGrad.addColorStop(0, dark?'#636e72':'#fff'); headGrad.addColorStop(1, dark?'#2d3436':'#dfe6e9');
            ctx.fillStyle = headGrad;
            ctx.beginPath(); ctx.arc(0,0,68,0,Math.PI*2); ctx.fill();

            // Face
            if(d.anim === 'sleep') {
                ctx.strokeStyle = '#333'; ctx.lineWidth=3;
                ctx.beginPath(); ctx.arc(-25,0,10,0,Math.PI,false); ctx.stroke();
                ctx.beginPath(); ctx.arc(25,0,10,0,Math.PI,false); ctx.stroke();
                if(Math.random()<0.02) this.particles.push({x:d.x+30, y:d.y-160, t:'z', vx:0.5, vy:-1, life:1});
            } else {
                // Eyes follow cursor
                const lx = (Input.x - W/2)/30; const ly = (Input.y - H/2)/30;
                
                // Eye Whites
                ctx.fillStyle='white';
                ctx.beginPath(); ctx.ellipse(-25, -5, 14, 18, 0,0,Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.ellipse(25, -5, 14, 18, 0,0,Math.PI*2); ctx.fill();
                
                // Pupils (clamped)
                ctx.fillStyle='#2d3436';
                const px = Math.max(-5, Math.min(5, lx));
                const py = Math.max(-5, Math.min(5, ly));
                ctx.beginPath(); ctx.arc(-25+px, -5+py, 7, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(25+px, -5+py, 7, 0, Math.PI*2); ctx.fill();

                // Blinking
                d.blinkTimer--;
                if(d.blinkTimer <= 0) { d.blinkTimer = Math.random()*200 + 100; }
                if(d.blinkTimer < 10) {
                    ctx.fillStyle = headGrad;
                    ctx.beginPath(); ctx.rect(-50, -25, 100, 25); ctx.fill(); // Eyelid
                }
            }

            // Snout
            ctx.fillStyle = '#fff';
            ctx.beginPath(); ctx.ellipse(0, 20, 28, 20, 0,0,Math.PI*2); ctx.fill();
            ctx.fillStyle = '#2d3436';
            ctx.beginPath(); ctx.ellipse(0, 15, 12, 8, 0,0,Math.PI*2); ctx.fill();

            // Mouth (Dynamic Expression)
            const happy = (this.needs.food > 50);
            ctx.lineWidth=3; ctx.strokeStyle='#2d3436'; ctx.beginPath();
            
            if(d.anim === 'talk') {
                const open = 10 + Math.abs(Math.sin(Date.now()/50)*12);
                ctx.fillStyle = '#ff7675';
                ctx.beginPath(); ctx.arc(0, 32, open, 0, Math.PI); ctx.fill();
            } else if(happy) {
                ctx.moveTo(-10, 32); ctx.quadraticCurveTo(0, 40, 10, 32); ctx.stroke();
            } else {
                ctx.moveTo(-5, 38); ctx.quadraticCurveTo(0, 35, 5, 38); ctx.stroke();
            }

            // Accessories
            if(this.inv.glasses) {
                ctx.fillStyle='rgba(0,0,0,0.8)';
                ctx.fillRect(-65, -20, 50, 30); ctx.fillRect(15, -20, 50, 30);
                ctx.fillRect(-15, -15, 30, 5);
            }
            if(this.inv.hat) {
                ctx.fillStyle='#ff4757';
                ctx.beginPath(); ctx.arc(0, -55, 60, Math.PI, 0); ctx.fill();
                ctx.fillRect(-65, -55, 130, 15);
            }
            if(this.inv.bowtie) {
                ctx.translate(0, 60); // Move to neck
                ctx.fillStyle='#e84393';
                ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(-20,-10); ctx.lineTo(-20,10); ctx.fill();
                ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(20,-10); ctx.lineTo(20,10); ctx.fill();
            }

            ctx.restore();
        },

        drawParticles() {
            for(let i=this.particles.length-1; i>=0; i--) {
                let p = this.particles[i];
                p.x += p.vx; p.y += p.vy; p.life -= 0.02;
                ctx.globalAlpha = Math.max(0, p.life);
                if(p.t==='z') { ctx.fillStyle='white'; ctx.font='24px Arial'; ctx.fillText('Z',p.x,p.y); }
                else if(p.t==='bubble') {
                    ctx.strokeStyle='white'; ctx.lineWidth=2; ctx.beginPath(); ctx.arc(p.x,p.y,8,0,Math.PI*2); ctx.stroke();
                } else {
                    ctx.font='24px Arial'; ctx.fillText(p.t, p.x, p.y);
                }
                ctx.globalAlpha = 1;
                if(p.life<=0) this.particles.splice(i,1);
            }
        }
    };

    /** RHYTHM GAME **/
    const RhythmGame = {
        active: false,
        score: 0,
        notes: [],
        spawnTimer: 0,
        
        start() {
            this.active = true; Game.state = 'GAME';
            this.score = 0; this.notes = [];
            document.getElementById('ui').style.display='none';
            document.getElementById('game-ui').style.display='flex';
        },
        
        stop() {
            this.active = false; Game.state = 'HOME';
            Game.coins += Math.floor(this.score/10);
            document.getElementById('ui').style.display='flex';
            document.getElementById('game-ui').style.display='none';
            UI.toast(`Earned ${Math.floor(this.score/10)} Coins!`);
        },

        loop() {
            // Background
            ctx.fillStyle = '#222'; ctx.fillRect(0,0,W,H);
            
            // Lanes
            ctx.strokeStyle = '#555'; ctx.lineWidth = 4;
            const laneW = W/3;
            ctx.beginPath(); ctx.moveTo(W/2 - 100, 0); ctx.lineTo(W/2 - 100, H); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(W/2 + 100, 0); ctx.lineTo(W/2 + 100, H); ctx.stroke();
            
            // Hit Line
            ctx.strokeStyle = '#00b894'; ctx.lineWidth = 8;
            ctx.beginPath(); ctx.moveTo(0, H-100); ctx.lineTo(W, H-100); ctx.stroke();

            // Spawn
            this.spawnTimer++;
            if(this.spawnTimer > 40) {
                this.spawnTimer = 0;
                const lane = Math.random() > 0.5 ? 0 : 1;
                this.notes.push({lane: lane, y: -50, hit: false});
            }

            // Draw Notes
            for(let i=this.notes.length-1; i>=0; i--) {
                let n = this.notes[i];
                n.y += 8;
                const x = n.lane === 0 ? W/2 - 50 : W/2 + 50;
                
                ctx.fillStyle = n.lane === 0 ? '#ff7675' : '#74b9ff';
                ctx.beginPath(); ctx.arc(x, n.y, 30, 0, Math.PI*2); ctx.fill();
                
                // Miss
                if(n.y > H) {
                    this.notes.splice(i,1);
                    this.score = Math.max(0, this.score - 50);
                    AudioSys.sfx('pop');
                }
            }
            document.getElementById('rhythm-score').innerText = this.score;
        },

        hit(lane) {
            // Check collision with hit line
            let hit = false;
            for(let i=0; i<this.notes.length; i++) {
                let n = this.notes[i];
                if(n.lane === lane && Math.abs(n.y - (H-100)) < 60) {
                    this.notes.splice(i,1);
                    this.score += 100;
                    AudioSys.sfx('coin');
                    hit = true;
                    // Visual feedback
                    const x = lane === 0 ? W/2 - 50 : W/2 + 50;
                    Game.particles.push({x:x, y:H-100, t:'‚ú®', vx:0, vy:-5, life:0.5});
                    break;
                }
            }
        }
    };

    /** INPUT **/
    const Input = {
        x:0, y:0, drag:null,
        startDrag(t, e) {
            if(Game.dark) return UI.toast("Sleeping zzz...");
            e.preventDefault();
            this.drag=t;
            const g=document.getElementById('ghost');
            g.innerText = t==='food'?'üçî':'üßº';
            g.style.display='block';
            this.move(e);
        },
        move(e) {
            const cx = e.touches?e.touches[0].clientX:e.clientX;
            const cy = e.touches?e.touches[0].clientY:e.clientY;
            this.x=cx; this.y=cy;
            if(this.drag) {
                const g=document.getElementById('ghost');
                g.style.left=cx+'px'; g.style.top=cy+'px';
            }
        },
        end() {
            if(!this.drag) return;
            const dist = Math.hypot(this.x-Game.dog.x, this.y-(Game.dog.y-50));
            
            if(this.drag==='food' && dist<80) {
                Game.needs.food = Math.min(100, Game.needs.food+15);
                Game.dog.scaleY = 0.8; AudioSys.sfx('coin');
                Game.particles.push({x:Game.dog.x, y:Game.dog.y-50, t:'üòã', vx:0, vy:-2, life:1});
            }
            if(this.drag==='sponge' && dist<90) {
                Game.needs.clean = Math.min(100, Game.needs.clean+0.5);
                if(Math.random()<0.2) {
                    AudioSys.sfx('pop');
                    Game.particles.push({x:this.x, y:this.y, t:'bubble', vx:Math.random()-0.5, vy:-2, life:1});
                }
            }
            this.drag=null;
            document.getElementById('ghost').style.display='none';
        }
    };
    window.addEventListener('pointermove',e=>Input.move(e));
    window.addEventListener('pointerup',e=>Input.end());

    const UI = {
        update() {
            document.getElementById('bar-food').style.width = Game.needs.food+'%';
            document.getElementById('bar-clean').style.width = Game.needs.clean+'%';
            document.getElementById('bar-energy').style.width = Game.needs.energy+'%';
            document.getElementById('coin-txt').innerText = Game.coins;
        },
        openShop() { document.getElementById('modal-shop').style.display='flex'; },
        close() { document.getElementById('modal-shop').style.display='none'; },
        toast(m) {
            const t = document.getElementById('toast');
            t.innerText=m; t.style.opacity=1; t.style.transform='translate(-50%, 0)';
            setTimeout(()=>{ t.style.opacity=0; t.style.transform='translate(-50%, 10px)'; }, 2000);
        }
    };

    Game.init();
</script>
</body>
</html>
