<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Golden Dog Tycoon (Final Fixed)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Montserrat:wght@300;600&display=swap');

        :root {
            --gold: #FFD700;
            --gold-dark: #B8860B;
            --gold-grad: linear-gradient(135deg, #FFF8DC, #FFD700, #B8860B, #8B4513);
            --black: #050505;
            --glass: rgba(20, 20, 20, 0.9);
        }

        body {
            margin: 0; overflow: hidden; background: var(--black);
            font-family: 'Montserrat', sans-serif; color: white;
            touch-action: none; user-select: none;
        }

        canvas { display: block; width: 100%; height: 100%; }

        /* UI CONTAINER */
        #ui {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: flex; flex-direction: column;
            justify-content: space-between; z-index: 10;
        }

        /* HEADER */
        .header {
            padding: 20px; display: flex; justify-content: space-between; align-items: flex-start;
            pointer-events: auto; background: linear-gradient(to bottom, rgba(0,0,0,0.95), transparent);
        }

        .wealth-display {
            text-align: right; text-shadow: 0 0 10px var(--gold);
        }
        .net-worth { font-size: 28px; font-weight: 700; color: var(--gold); font-family: 'Cinzel', serif; }
        .stock-ticker { font-size: 12px; color: #2ecc71; font-weight: 600; margin-top: 5px; }

        /* BARS */
        .bars {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 5px;
        }
        .bar-col { width: 10px; height: 40px; background: rgba(255,255,255,0.1); border: 1px solid #444; border-radius: 20px; overflow: hidden; }
        .bar-fill { width: 100%; height: 100%; background: white; transform-origin: bottom; transition: transform 0.5s; }

        /* DOCK */
        .dock {
            padding: 30px; display: flex; justify-content: center; gap: 20px;
            background: linear-gradient(to top, #000, transparent); pointer-events: auto;
        }

        .lux-btn {
            width: 75px; height: 75px; border-radius: 20px;
            background: rgba(10,10,10,0.9); border: 1px solid var(--gold);
            color: var(--gold); font-size: 30px; cursor: pointer;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5); position: relative;
            transition: 0.2s; overflow: hidden;
        }
        .lux-btn:active { transform: scale(0.95); background: var(--gold); color: black; }
        .lux-btn::after {
            content: attr(data-label); position: absolute; bottom: 5px; left:0; width:100%;
            font-size: 9px; font-weight: 700; letter-spacing: 1px;
        }

        #mic-btn {
            width: 90px; height: 90px; border-radius: 50%; margin-top: -20px;
            background: var(--gold-grad); color: black; border: 3px solid white;
            box-shadow: 0 0 30px var(--gold-dark); animation: shine 3s infinite linear;
        }
        #mic-btn.active { animation: pulse 0.5s infinite; background: #ff4757; }

        /* MODALS */
        .modal {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.92); backdrop-filter: blur(10px);
            z-index: 100; display: none; align-items: center; justify-content: center;
            pointer-events: auto;
        }
        .modal-content {
            background: #0a0a0a; width: 90%; max-width: 500px;
            border: 1px solid var(--gold); padding: 2px;
            box-shadow: 0 0 60px rgba(184, 134, 11, 0.3);
        }
        .inner-box {
            border: 1px solid var(--gold-dark); padding: 25px;
            display: flex; flex-direction: column; gap: 20px;
        }
        h2 { margin: 0; font-family: 'Cinzel', serif; color: var(--gold); text-align: center; }

        /* STOCK GRAPH */
        .graph-container {
            width: 100%; height: 150px; background: #111; border: 1px solid #333;
            position: relative; overflow: hidden; display: flex; align-items: flex-end; gap: 2px;
        }
        .graph-bar { width: 5%; background: #2ecc71; transition: height 0.2s; opacity: 0.8; }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .lux-btn-wide { width: 100%; padding: 15px; font-size: 18px; border: 1px solid var(--gold); background: #111; color: var(--gold); cursor: pointer; font-family: 'Cinzel'; }
        
        #ghost {
            position: fixed; font-size: 60px; pointer-events: none; z-index: 500;
            display: none; transform: translate(-50%, -50%); filter: drop-shadow(0 0 15px var(--gold));
        }

        .toast {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: var(--gold-grad); color: black; padding: 15px 30px;
            font-family: 'Cinzel', serif; font-weight: 900; font-size: 18px;
            opacity: 0; pointer-events: none; transition: 0.4s; z-index: 200;
            box-shadow: 0 0 30px var(--gold); text-align: center;
        }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

<canvas id="cvs"></canvas>

<div id="ui">
    <div class="header">
        <div style="display:flex; flex-direction:column;">
            <div style="color:var(--gold); font-family:'Cinzel'">MY PET</div>
            <div style="font-size:12px; color:#888;">LVL <span id="lvl-txt">1</span></div>
        </div>
        
        <div class="bars">
            <div class="bar-col"><div class="bar-fill" id="fill-food"></div></div>
            <div class="bar-col"><div class="bar-fill" id="fill-clean"></div></div>
            <div class="bar-col"><div class="bar-fill" id="fill-energy"></div></div>
        </div>

        <div class="wealth-display">
            <div class="net-worth">$<span id="cash-txt">0</span></div>
            <div class="stock-ticker">STOCKS: <span id="stock-owned-display">0</span></div>
        </div>
    </div>

    <div class="dock">
        <button class="lux-btn" data-label="STOCKS" onclick="UI.open('stocks')">üìà</button>
        <button class="lux-btn" data-label="SHOP" onclick="UI.open('shop')">üëú</button>
        
        <!-- MIC FIX APPLIED -->
        <button class="lux-btn" id="mic-btn" 
            onpointerdown="AudioSys.startRecording(event)" 
            onpointerup="AudioSys.stopRecording(event)"
            onpointerleave="AudioSys.stopRecording(event)">üéôÔ∏è</button>
            
        <button class="lux-btn" data-label="FEED" onpointerdown="Input.start('caviar', event)">üç±</button>
        <button class="lux-btn" data-label="RESET" onclick="SaveSys.reset()">‚ö†Ô∏è</button>
    </div>
</div>

<div id="ghost"></div>
<div id="toast">SAVED</div>

<!-- STOCKS MODAL -->
<div id="modal-stocks" class="modal">
    <div class="modal-content"><div class="inner-box">
        <div style="display:flex; justify-content:space-between;">
            <h2>Stock Market</h2>
            <button class="lux-btn" style="width:40px; height:40px; font-size:16px;" onclick="UI.close()">‚úï</button>
        </div>
        <div class="graph-container" id="stock-graph"></div>
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <div>
                <div style="color:#888;">GOLD COIN</div>
                <div style="font-size:24px; color:white;">$<span id="stock-price">0</span></div>
            </div>
            <div style="color:#2ecc71;" id="stock-change">+0%</div>
        </div>
        <div class="grid">
            <button class="lux-btn-wide" onclick="StockMarket.buy()">BUY</button>
            <button class="lux-btn-wide" onclick="StockMarket.sell()">SELL</button>
        </div>
        <div style="text-align:center; color:#888;">Owned Shares: <span id="stock-owned">0</span></div>
    </div></div>
</div>

<!-- SHOP MODAL -->
<div id="modal-shop" class="modal">
    <div class="modal-content"><div class="inner-box">
        <div style="display:flex; justify-content:space-between;">
            <h2>Luxury Shop</h2>
            <button class="lux-btn" style="width:40px; height:40px; font-size:16px;" onclick="UI.close()">‚úï</button>
        </div>
        <div class="grid">
            <button class="lux-btn-wide" onclick="Game.buySkin('gold', 5000)">GOLD SKIN<br><small>$5000</small></button>
            <button class="lux-btn-wide" onclick="Game.buySkin('diamond', 10000)">DIAMOND<br><small>$10000</small></button>
            <button class="lux-btn-wide" onclick="Game.buyItem('hat', 500)">TOP HAT<br><small>$500</small></button>
            <button class="lux-btn-wide" onclick="Game.buyItem('monocle', 300)">MONOCLE<br><small>$300</small></button>
        </div>
    </div></div>
</div>

<script>
    /** AUDIO SYSTEM (FIXED - NO RELOAD NEEDED) **/
    const AudioSys = {
        ctx: null,
        stream: null,
        recorder: null,
        chunks: [],
        isRecording: false,

        init() {
            if (!this.ctx) {
                this.ctx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (this.ctx.state === 'suspended') {
                this.ctx.resume();
            }
        },

        sfx(t) {
            this.init();
            const o = this.ctx.createOscillator();
            const g = this.ctx.createGain();
            o.connect(g); g.connect(this.ctx.destination);
            const n = this.ctx.currentTime;
            
            if (t === 'cash') {
                o.type = 'sine'; o.frequency.setValueAtTime(1200, n); 
                o.frequency.linearRampToValueAtTime(2000, n + 0.2);
                g.gain.setValueAtTime(0.1, n); g.gain.linearRampToValueAtTime(0, n + 0.4);
                o.start(); o.stop(n + 0.4);
            }
        },

        async startRecording(e) {
            if(e) e.preventDefault();
            if (this.isRecording) return;
            
            this.init();
            this.isRecording = true;
            document.getElementById('mic-btn').classList.add('active');
            Game.dog.anim = 'listen';
            UI.toast("Listening...");

            try {
                this.stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                this.recorder = new MediaRecorder(this.stream);
                this.chunks = [];

                this.recorder.ondataavailable = e => this.chunks.push(e.data);
                this.recorder.start();

            } catch (err) {
                alert("Microphone Access Required");
                this.forceStop();
            }
        },

        stopRecording(e) {
            if(e) e.preventDefault();
            if (!this.isRecording || !this.recorder) return;

            if(this.recorder.state !== 'inactive') this.recorder.stop();
            
            this.isRecording = false;
            document.getElementById('mic-btn').classList.remove('active');

            // CRITICAL FIX: Kill audio stream immediately
            if (this.stream) {
                this.stream.getTracks().forEach(track => track.stop());
                this.stream = null;
            }

            this.recorder.onstop = async () => {
                if(this.chunks.length === 0) return;
                
                const blob = new Blob(this.chunks, { type: 'audio/ogg; codecs=opus' });
                this.chunks = [];
                
                try {
                    const buf = await this.ctx.decodeAudioData(await blob.arrayBuffer());
                    this.playPitch(buf);
                } catch(e) {}
            };
        },

        forceStop() {
            this.isRecording = false;
            document.getElementById('mic-btn').classList.remove('active');
            if (this.stream) this.stream.getTracks().forEach(track => track.stop());
            this.stream = null;
            this.recorder = null;
            Game.dog.anim = 'idle';
        },

        playPitch(buffer) {
            const src = this.ctx.createBufferSource();
            src.buffer = buffer;
            src.playbackRate.value = 1.35; // Cute High Pitch
            
            const gain = this.ctx.createGain();
            gain.gain.value = 1.5;

            src.connect(gain);
            gain.connect(this.ctx.destination);
            
            src.start();
            Game.dog.anim = 'talk';
            src.onended = () => { Game.dog.anim = 'idle'; };
        }
    };

    /** SAVE SYSTEM **/
    const SaveSys = {
        key: 'goldenDog_v4',
        save() {
            const data = {
                cash: Game.cash,
                skin: Game.skin,
                inv: Game.inv,
                stockOwned: StockMarket.owned,
                needs: Game.needs
            };
            localStorage.setItem(this.key, JSON.stringify(data));
        },
        load() {
            const saved = localStorage.getItem(this.key);
            if(saved) {
                const d = JSON.parse(saved);
                Game.cash = d.cash || 2000;
                Game.skin = d.skin || 'default';
                Game.inv = d.inv || {};
                StockMarket.owned = d.stockOwned || 0;
                Game.needs = d.needs || {food:80,clean:80,energy:90};
            }
        },
        reset() {
            if(confirm("Start fresh?")) {
                localStorage.removeItem(this.key);
                location.reload();
            }
        }
    };

    /** STOCK MARKET LOGIC **/
    const StockMarket = {
        price: 100,
        history: [],
        owned: 0,
        
        update() {
            const change = (Math.random()-0.45) * 8; // Slight upward trend
            this.price = Math.max(10, this.price + change);
            this.history.push(this.price);
            if(this.history.length > 20) this.history.shift();
            
            if(document.getElementById('modal-stocks').style.display === 'flex') {
                this.drawGraph();
                document.getElementById('stock-price').innerText = this.price.toFixed(2);
                document.getElementById('stock-owned').innerText = this.owned;
                const el = document.getElementById('stock-change');
                el.innerText = (change>0?'+':'') + change.toFixed(2);
                el.style.color = change>0?'#2ecc71':'#e74c3c';
            }
        },
        drawGraph() {
            const c = document.getElementById('stock-graph');
            c.innerHTML = '';
            this.history.forEach(h => {
                const d = document.createElement('div');
                d.className = 'graph-bar';
                d.style.height = Math.min(100, (h/2)) + 'px';
                c.appendChild(d);
            });
        },
        buy() {
            if(Game.cash >= this.price) {
                Game.cash -= this.price;
                this.owned++;
                AudioSys.sfx('cash');
                UI.update();
                SaveSys.save();
                this.update();
            } else UI.toast("Need Cash!");
        },
        sell() {
            if(this.owned > 0) {
                Game.cash += this.price;
                this.owned--;
                AudioSys.sfx('cash');
                UI.update();
                SaveSys.save();
                this.update();
            } else UI.toast("No Stocks!");
        }
    };

    /** GAME CORE **/
    const cvs = document.getElementById('cvs');
    const ctx = cvs.getContext('2d');
    let W, H;

    const Game = {
        cash: 2000,
        skin: 'default',
        inv: { hat:false, monocle:false },
        needs: { food:80, clean:80, energy:90 },
        dog: { x:0, y:0, scaleY:1, anim:'idle', blink:0 },
        particles: [],

        init() {
            this.resize();
            window.addEventListener('resize', ()=>this.resize());
            SaveSys.load(); 
            this.loop();
            setInterval(()=>this.logic(), 1000);
            setInterval(()=>StockMarket.update(), 1500);
            setInterval(()=>SaveSys.save(), 5000);
        },

        resize() {
            W=window.innerWidth; H=window.innerHeight;
            cvs.width=W; cvs.height=H;
            this.dog.x=W/2; this.dog.y=H/2+80;
        },

        logic() {
            this.needs.food = Math.max(0, this.needs.food-1);
            this.needs.clean = Math.max(0, this.needs.clean-0.5);
            this.needs.energy = Math.max(0, this.needs.energy-0.5);
            UI.update();
        },

        buySkin(skin, cost) {
            if(Game.cash >= cost) {
                Game.cash -= cost;
                Game.skin = skin;
                UI.toast("Skin Applied!");
                SaveSys.save();
                UI.close();
            } else UI.toast("Too Expensive!");
        },

        buyItem(item, cost) {
            if(Game.cash >= cost && !Game.inv[item]) {
                Game.cash -= cost;
                Game.inv[item] = true;
                UI.toast("Purchased!");
                SaveSys.save();
            } else UI.toast("Can't Buy");
        },

        loop() {
            ctx.clearRect(0,0,W,H);
            this.drawBackground();
            this.drawDog();
            this.drawParticles();
            requestAnimationFrame(()=>this.loop());
        },

        drawBackground() {
            // Penthouse Night View
            const g = ctx.createLinearGradient(0,0,0,H);
            g.addColorStop(0, '#1a0b2e'); g.addColorStop(1, '#000');
            ctx.fillStyle=g; ctx.fillRect(0,0,W,H);

            // City Lights
            ctx.fillStyle = '#f1c40f';
            for(let i=0; i<20; i++) {
                if(Math.random()>0.95) ctx.fillRect(Math.random()*W, H-Math.random()*300, 2, 2);
            }
            
            // Floor Reflection
            const fg = ctx.createLinearGradient(0,H-200,0,H);
            fg.addColorStop(0, 'rgba(50,50,50,0.5)'); fg.addColorStop(1, '#000');
            ctx.fillStyle=fg; ctx.fillRect(0,H-200,W,200);
        },

        drawDog() {
            const d = this.dog;
            const b = Math.sin(Date.now()/900)*4;
            let sy = d.scaleY + (b*0.003);
            
            ctx.save();
            ctx.translate(d.x, d.y);
            ctx.scale(1, sy);

            // Shadow
            ctx.fillStyle='rgba(0,0,0,0.5)'; ctx.shadowBlur=0;
            ctx.beginPath(); ctx.ellipse(0, 95, 80, 20, 0,0,Math.PI*2); ctx.fill();

            // Colors
            let mainC='#bdc3c7', shadC='#7f8c8d';
            if(Game.skin==='gold') { mainC='#FFD700'; shadC='#B8860B'; }
            if(Game.skin==='diamond') { mainC='#00f3ff'; shadC='#0097e6'; ctx.shadowBlur=15; ctx.shadowColor='#00f3ff'; }

            // Tail
            if(d.anim!=='sleep') {
                const wag = Math.sin(Date.now()/100)*15;
                ctx.strokeStyle=shadC; ctx.lineWidth=18; ctx.lineCap='round';
                ctx.beginPath(); ctx.moveTo(40,60); ctx.quadraticCurveTo(70,50,80,10+wag); ctx.stroke();
            }

            // Body
            const bodyG = ctx.createRadialGradient(-20,-20,10,0,0,80);
            bodyG.addColorStop(0, mainC); bodyG.addColorStop(1, shadC);
            ctx.fillStyle=bodyG;
            ctx.beginPath(); ctx.moveTo(-45,80); ctx.quadraticCurveTo(-70,80,-60,-20);
            ctx.lineTo(60,-20); ctx.quadraticCurveTo(70,80,45,80); ctx.fill();

            // Head (Standard Dog Face)
            ctx.translate(0, -60+b);
            ctx.fillStyle=shadC; // Ears
            ctx.beginPath(); ctx.ellipse(-50,0,20,50,0.2,0,Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.ellipse(50,0,20,50,-0.2,0,Math.PI*2); ctx.fill();

            const headG = ctx.createRadialGradient(0,0,10,0,0,70);
            headG.addColorStop(0, mainC); headG.addColorStop(1, shadC);
            ctx.fillStyle=headG; ctx.beginPath(); ctx.arc(0,0,70,0,Math.PI*2); ctx.fill();

            // Eyes (Tracking)
            const lx=(Input.x-W/2)/30; const ly=(Input.y-H/2)/30;
            ctx.fillStyle='white';
            ctx.beginPath(); ctx.ellipse(-25,-5,15,20,0,0,Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.ellipse(25,-5,15,20,0,0,Math.PI*2); ctx.fill();
            
            ctx.fillStyle='#000';
            const px=Math.min(5,Math.max(-5,lx)); const py=Math.min(5,Math.max(-5,ly));
            ctx.beginPath(); ctx.arc(-25+px,-5+py,8,0,Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(25+px,-5+py,8,0,Math.PI*2); ctx.fill();

            // Snout & Mouth
            ctx.fillStyle='white'; ctx.globalAlpha=0.7;
            ctx.beginPath(); ctx.ellipse(0,20,30,22,0,0,Math.PI*2); ctx.fill();
            ctx.globalAlpha=1;
            ctx.fillStyle='#000'; ctx.beginPath(); ctx.ellipse(0,15,14,9,0,0,Math.PI*2); ctx.fill();

            if(d.anim==='talk') {
                ctx.fillStyle='#e74c3c';
                const o=10+Math.abs(Math.sin(Date.now()/50)*15);
                ctx.beginPath(); ctx.arc(0,35,o,0,Math.PI); ctx.fill();
            } else {
                ctx.strokeStyle='#000'; ctx.lineWidth=3;
                ctx.beginPath(); ctx.moveTo(-10,35); ctx.quadraticCurveTo(0,42,10,35); ctx.stroke();
            }

            // Accessories
            ctx.shadowBlur=0;
            if(Game.inv.hat) {
                ctx.fillStyle='#111'; ctx.beginPath(); ctx.rect(-50,-70,100,60); ctx.fill();
                ctx.beginPath(); ctx.rect(-70,-10,140,10); ctx.fill();
            }
            if(Game.inv.monocle) {
                ctx.strokeStyle='gold'; ctx.lineWidth=3; ctx.beginPath(); ctx.arc(25,-5,20,0,Math.PI*2); ctx.stroke();
            }

            ctx.restore();
        },

        drawParticles() {
            if(Math.random()<0.05 && Game.skin!=='default') {
                this.particles.push({x:this.dog.x+(Math.random()-0.5)*100, y:this.dog.y+(Math.random()-0.5)*100, t:'‚ú®', vx:0, vy:-1, life:1});
            }
            for(let i=this.particles.length-1; i>=0; i--) {
                let p = this.particles[i];
                p.x+=p.vx; p.y+=p.vy; p.life-=0.02;
                ctx.globalAlpha=p.life;
                if(p.t==='‚ú®') { ctx.fillStyle='gold'; ctx.fillText('‚ú¶',p.x,p.y); }
                else { ctx.font='24px Arial'; ctx.fillText(p.t,p.x,p.y); }
                ctx.globalAlpha=1;
                if(p.life<=0) this.particles.splice(i,1);
            }
        }
    };

    /** INPUT **/
    const Input = {
        x:0, y:0, drag:null,
        start(t, e) {
            e.preventDefault();
            this.drag=t;
            const g=document.getElementById('ghost');
            g.innerText=t==='caviar'?'üç±':'';
            g.style.display='block';
            this.move(e);
        },
        move(e) {
            const cx=e.touches?e.touches[0].clientX:e.clientX;
            const cy=e.touches?e.touches[0].clientY:e.clientY;
            this.x=cx; this.y=cy;
            if(this.drag) {
                const g=document.getElementById('ghost');
                g.style.left=cx+'px'; g.style.top=cy+'px';
            }
        },
        end() {
            if(!this.drag) return;
            if(Math.hypot(this.x-Game.dog.x, this.y-(Game.dog.y-50)) < 100) {
                if(this.drag==='caviar') {
                    if(Game.cash >= 50) {
                        Game.cash-=50;
                        Game.needs.food = Math.min(100, Game.needs.food+30);
                        Game.dog.scaleY=0.8; AudioSys.sfx('cash');
                        Game.particles.push({x:Game.dog.x,y:Game.dog.y-50,t:'üòã',vx:0,vy:-2,life:1});
                        UI.update(); SaveSys.save();
                    } else UI.toast("Caviar: $50");
                }
            }
            this.drag=null;
            document.getElementById('ghost').style.display='none';
        }
    };
    window.addEventListener('pointermove',e=>Input.move(e));
    window.addEventListener('pointerup',e=>Input.end());

    const UI = {
        update() {
            document.getElementById('cash-txt').innerText = Math.floor(Game.cash).toLocaleString();
            document.getElementById('stock-owned-display').innerText = StockMarket.owned;
            document.getElementById('fill-food').style.transform = `scaleY(${Game.needs.food/100})`;
            document.getElementById('fill-clean').style.transform = `scaleY(${Game.needs.clean/100})`;
            document.getElementById('fill-energy').style.transform = `scaleY(${Game.needs.energy/100})`;
        },
        open(id) { document.getElementById('modal-'+id).style.display='flex'; },
        close() { document.querySelectorAll('.modal').forEach(m=>m.style.display='none'); },
        toast(m) {
            const t=document.getElementById('toast');
            t.innerText=m; t.style.opacity=1;
            setTimeout(()=>t.style.opacity=0, 2000);
        }
    };

    Game.init();
</script>
</body>
</html>
