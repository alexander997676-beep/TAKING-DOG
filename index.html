<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Talking Dog: Fixed Buttons</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@600&display=swap');

        body {
            margin: 0;
            padding: 0;
            background: #222;
            font-family: 'Nunito', sans-serif;
            overflow: hidden; /* Scroll band */
        }

        /* --- MAIN CONTAINER (Fixes Screen Size) --- */
        #app {
            position: fixed; /* Screen par chipka rahega */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%; /* Puri height lega */
            background: #fff;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- TOP STATS (HUD) --- */
        #hud {
            position: absolute;
            top: 0; left: 0; width: 100%;
            padding: 15px 15px 0 15px;
            box-sizing: border-box;
            display: flex; gap: 10px; z-index: 10;
            pointer-events: none;
        }

        .meter-container {
            flex: 1; background: rgba(0,0,0,0.3); height: 12px;
            border-radius: 10px; position: relative;
            border: 2px solid rgba(255,255,255,0.8); margin-top: 15px;
        }
        .meter-fill { height: 100%; border-radius: 8px; transition: width 0.5s; }
        .icon-label {
            position: absolute; top: -22px; left: 2px;
            font-size: 13px; font-weight: bold; color: #444;
            text-shadow: 1px 1px 0 rgba(255,255,255,0.8);
        }

        /* --- GAME CANVAS --- */
        canvas {
            flex-grow: 1; /* Bachi hui jagah lega */
            width: 100%;
            background: transparent;
            cursor: pointer;
        }

        /* --- BOTTOM TOOLBAR (Buttons) --- */
        #toolbar {
            height: 80px; /* Thoda chhota kiya taaki fit ho */
            min-height: 80px;
            background: white;
            display: flex;
            justify-content: space-around;
            align-items: center;
            border-top: 4px solid #eee;
            z-index: 20;
            /* iPhone/Android Safe Area Fix */
            padding-bottom: env(safe-area-inset-bottom, 20px); 
        }

        .tool-btn {
            width: 50px; height: 50px; border: none; border-radius: 15px;
            background: #f1f2f6; font-size: 24px; cursor: pointer;
            box-shadow: 0 4px 0 #dfe4ea; transition: transform 0.1s;
        }
        .tool-btn:active { transform: translateY(4px); box-shadow: none; }

        /* MIC BUTTON (Center) */
        #mic-btn {
            width: 65px; height: 65px; border-radius: 50%;
            background: #ff5252; color: white;
            margin-top: -30px; /* Toolbar ke upar float karega */
            box-shadow: 0 5px 0 #b71c1c;
            display: flex; justify-content: center; align-items: center;
            font-size: 28px; cursor: pointer;
        }
        #mic-btn.recording { animation: recordPulse 1s infinite; background: #ff0000; }

        /* --- SIDE BUTTONS --- */
        #room-switch {
            position: absolute; right: 10px; top: 100px;
            display: flex; flex-direction: column; gap: 12px; z-index: 15;
        }
        .room-btn {
            width: 42px; height: 42px; border-radius: 50%;
            border: 2px solid white; background: rgba(0,0,0,0.3);
            color: white; cursor: pointer; font-size: 20px;
        }

        /* --- OVERLAY --- */
        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); color: white;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 100;
        }
        .start-btn {
            margin-top: 30px; padding: 15px 50px; font-size: 22px;
            background: #43a047; color: white; border: none;
            border-radius: 50px; cursor: pointer;
        }

        @keyframes recordPulse { 0% { transform: scale(1); } 50% { transform: scale(1.15); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

<div id="app">
    <!-- Stats -->
    <div id="hud">
        <div class="meter-container"><span class="icon-label">üçó Food</span><div class="meter-fill" id="bar-hunger" style="background: #ffb74d; width: 80%;"></div></div>
        <div class="meter-container"><span class="icon-label">üßº Clean</span><div class="meter-fill" id="bar-clean" style="background: #4fc3f7; width: 60%;"></div></div>
        <div class="meter-container"><span class="icon-label">‚ö° Energy</span><div class="meter-fill" id="bar-energy" style="background: #aed581; width: 90%;"></div></div>
    </div>

    <!-- Right Side Buttons -->
    <div id="room-switch">
        <button class="room-btn" onclick="game.setRoom('living')">üè†</button>
        <button class="room-btn" onclick="game.setRoom('kitchen')">üçñ</button>
        <button class="room-btn" onclick="game.setRoom('bath')">üöø</button>
        <button class="room-btn" onclick="game.setRoom('bed')">üõå</button>
    </div>

    <!-- Main Game Canvas -->
    <canvas id="stage"></canvas>

    <!-- Bottom Buttons (Toolbar) -->
    <div id="toolbar">
        <button class="tool-btn" onclick="game.action('feed')">ü•©</button>
        <button class="tool-btn" onclick="game.action('shower')">üßº</button>
        <div id="mic-btn">üéôÔ∏è</div>
        <button class="tool-btn" onclick="game.action('ball')">üéæ</button>
        <button class="tool-btn" onclick="game.action('sleep')">üí§</button>
    </div>

    <!-- Start Screen -->
    <div id="overlay">
        <h1 style="font-family:'Fredoka One'; font-size:40px; color:#ffca28; margin:0;">TALKING DOG</h1>
        <p>Fixed Buttons Edition</p>
        <button class="start-btn" id="init-btn">PLAY NOW</button>
    </div>
</div>

<script>
    /* AUDIO SYSTEM */
    class AudioEngine {
        constructor() { this.ctx = null; }
        async init() {
            if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)();
            if (this.ctx.state === 'suspended') await this.ctx.resume();
        }
        playTone(freq, type = 'sine') {
            if(!this.ctx) return;
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.type = type; osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.3);
            osc.connect(gain); gain.connect(this.ctx.destination);
            osc.start(); osc.stop(this.ctx.currentTime + 0.3);
        }
        playBuffer(buffer) {
            if(!this.ctx) return;
            const source = this.ctx.createBufferSource();
            source.buffer = buffer;
            source.playbackRate.value = 0.85; 
            source.connect(this.ctx.destination);
            source.start();
            return source;
        }
    }

    /* GAME SYSTEM */
    const canvas = document.getElementById('stage');
    const ctx = canvas.getContext('2d');
    const audio = new AudioEngine();
    
    // Resize Logic (Important for Canvas)
    function resize() {
        // Toolbar ki height subtract karke canvas ko fit karenge
        const toolbarHeight = document.getElementById('toolbar').offsetHeight;
        canvas.width = document.getElementById('app').offsetWidth;
        canvas.height = document.getElementById('app').offsetHeight - toolbarHeight;
    }
    window.addEventListener('resize', resize);
    // Initial Call (thoda wait karke taaki elements load ho jayein)
    setTimeout(resize, 100);

    const game = {
        room: 'living', frame: 0, talking: false,
        stats: { hunger: 80, clean: 80, energy: 80 },
        particles: [], animState: 'idle', animTimer: 0,
        
        setRoom(r) { this.room = r; this.animState = 'idle'; audio.playTone(400, 'square'); },
        action(type) {
            if(type === 'feed') { this.setRoom('kitchen'); this.animState = 'eat'; this.animTimer = 60; this.stats.hunger += 30; this.spawnParticles(canvas.width/2, canvas.height/2 - 50, 'ü¶¥'); }
            if(type === 'shower') { this.setRoom('bath'); this.animState = 'shower'; this.animTimer = 100; this.stats.clean = 100; audio.playTone(200, 'sawtooth'); }
            if(type === 'sleep') { this.setRoom('bed'); this.animState = this.animState === 'sleep' ? 'idle' : 'sleep'; }
            if(type === 'ball') { this.setRoom('living'); this.animState = 'jump'; this.animTimer = 40; this.stats.energy -= 10; }
            updateUI();
        },
        spawnParticles(x, y, char) {
            for(let i=0; i<8; i++) this.particles.push({x, y, char, vx: (Math.random()-0.5)*10, vy: (Math.random()-1)*10, life: 1});
        }
    };

    /* MIC & TOUCH INPUTS */
    const micBtn = document.getElementById('mic-btn');
    let mediaRecorder, chunks = [];

    const startRec = async (e) => {
        if(e) e.preventDefault();
        await audio.init();
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            chunks = [];
            mediaRecorder.ondataavailable = e => chunks.push(e.data);
            mediaRecorder.start();
            micBtn.classList.add('recording');
        } catch(e) { alert("Mic Permission Needed"); }
    };
    const stopRec = (e) => {
        if(e) e.preventDefault();
        if(!mediaRecorder || mediaRecorder.state === 'inactive') return;
        mediaRecorder.stop();
        micBtn.classList.remove('recording');
        mediaRecorder.onstop = async () => {
            const blob = new Blob(chunks, { 'type' : 'audio/ogg; codecs=opus' });
            const buf = await audio.ctx.decodeAudioData(await blob.arrayBuffer());
            const src = audio.playBuffer(buf);
            game.talking = true; src.onended = () => game.talking = false;
        };
    };

    micBtn.addEventListener('mousedown', startRec); micBtn.addEventListener('touchstart', startRec);
    micBtn.addEventListener('mouseup', stopRec); micBtn.addEventListener('touchend', stopRec);

    canvas.addEventListener('pointerdown', (e) => {
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        const cy = canvas.height / 2 - 20; 
        audio.init();
        if (y < cy - 50) { game.spawnParticles(x, y, '‚ù§Ô∏è'); audio.playTone(600, 'sine'); game.animState = 'happy'; game.animTimer = 40; } 
        else if (y < cy + 80) { game.spawnParticles(x, y, 'üêæ'); audio.playTone(150, 'square'); }
    });

    /* RENDER LOOP */
    function updateUI() {
        document.getElementById('bar-hunger').style.width = Math.min(100, game.stats.hunger) + '%';
        document.getElementById('bar-clean').style.width = Math.min(100, game.stats.clean) + '%';
        document.getElementById('bar-energy').style.width = Math.min(100, game.stats.energy) + '%';
    }

    function loop() {
        game.frame++;
        if(game.frame % 300 === 0 && game.animState !== 'sleep') {
            game.stats.hunger = Math.max(0, game.stats.hunger - 2);
            game.stats.clean = Math.max(0, game.stats.clean - 1);
            game.stats.energy = Math.max(0, game.stats.energy - 1);
            updateUI();
        }
        if(game.animTimer > 0) { game.animTimer--; if(game.animTimer <= 0) game.animState = 'idle'; }
        draw();
        requestAnimationFrame(loop);
    }

    function draw() {
        let bgCol = '#a5d6a7';
        if(game.room === 'kitchen') bgCol = '#ffe082';
        if(game.room === 'bath') bgCol = '#81d4fa';
        if(game.room === 'bed') bgCol = game.animState === 'sleep' ? '#37474f' : '#b39ddb';
        ctx.fillStyle = bgCol; ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Floor - Adjusted
        ctx.fillStyle = 'rgba(0,0,0,0.1)';
        ctx.fillRect(0, canvas.height * 0.55, canvas.width, canvas.height * 0.45);

        drawDog();
        
        // Flies
        if(game.stats.clean < 50) {
            ctx.font = "24px Arial";
            ctx.fillText("ü™∞", canvas.width/2 - 70, canvas.height/2 - 60);
            ctx.fillText("ü™∞", canvas.width/2 + 70, canvas.height/2 - 100);
        }
        // Particles
        for(let i = game.particles.length - 1; i >= 0; i--) {
            let p = game.particles[i]; p.x += p.vx; p.y += p.vy; p.vy += 0.5; p.life -= 0.02;
            ctx.globalAlpha = p.life; ctx.font = "30px Arial"; ctx.fillText(p.char, p.x, p.y);
            ctx.globalAlpha = 1; if(p.life <= 0) game.particles.splice(i, 1);
        }
    }

    function drawDog() {
        const cx = canvas.width / 2;
        let cy = canvas.height / 2 - 20; 
        let breath = Math.sin(game.frame * 0.08) * 3;
        if(game.animState === 'jump') cy -= Math.abs(Math.sin(game.frame * 0.2) * 80);

        ctx.save(); ctx.translate(cx, cy);
        
        // Tail
        ctx.beginPath(); ctx.strokeStyle = '#8d6e63'; ctx.lineWidth = 15; ctx.lineCap = 'round';
        let tailSpeed = (game.animState === 'happy' || game.talking) ? 0.5 : 0.1;
        let tailWag = Math.cos(game.frame * tailSpeed) * 30;
        ctx.moveTo(40, 40); ctx.quadraticCurveTo(70, 20, 70 + tailWag, -30); ctx.stroke();

        // Body
        ctx.fillStyle = '#8d6e63'; ctx.beginPath(); ctx.ellipse(0, 50, 65, 75 + breath, 0, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = '#d7ccc8'; ctx.beginPath(); ctx.ellipse(0, 60, 35, 45 + breath, 0, 0, Math.PI*2); ctx.fill();

        // Head
        ctx.translate(0, -70 + breath);
        ctx.fillStyle = '#5d4037'; // Ears
        ctx.beginPath(); ctx.moveTo(-50, -30); ctx.bezierCurveTo(-90, -10, -80, 60, -50, 40); ctx.fill();
        ctx.beginPath(); ctx.moveTo(50, -30); ctx.bezierCurveTo(90, -10, 80, 60, 50, 40); ctx.fill();
        ctx.fillStyle = '#8d6e63'; ctx.beginPath(); ctx.arc(0, 0, 65, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = '#efebe9'; ctx.beginPath(); ctx.ellipse(0, 20, 35, 28, 0, 0, Math.PI*2); ctx.fill(); // Snout
        ctx.fillStyle = '#3e2723'; ctx.beginPath(); ctx.arc(0, 10, 12, 0, Math.PI*2); ctx.fill(); // Nose

        // Eyes
        let eyeOpen = (game.animState === 'sleep') ? 1 : 12;
        ctx.fillStyle = 'white'; ctx.beginPath(); ctx.ellipse(-25, -20, 14, eyeOpen, 0, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.ellipse(25, -20, 14, eyeOpen, 0, 0, Math.PI*2); ctx.fill();
        if(eyeOpen > 2) { ctx.fillStyle = 'black'; ctx.beginPath(); ctx.arc(-25, -20, 6, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(25, -20, 6, 0, Math.PI*2); ctx.fill(); }

        // Mouth
        ctx.fillStyle = '#e57373';
        if(game.talking || game.animState === 'happy') {
            ctx.beginPath(); ctx.arc(0, 30, 15, 0, Math.PI); ctx.fillStyle = '#3e2723'; ctx.fill();
            ctx.fillStyle = '#ff5252'; ctx.beginPath(); ctx.ellipse(0, 45, 8, 12, 0, 0, Math.PI*2); ctx.fill();
        } else {
            ctx.beginPath(); ctx.strokeStyle = '#3e2723'; ctx.lineWidth = 3;
            ctx.moveTo(0, 35); ctx.lineTo(0, 45); ctx.moveTo(0, 45); ctx.quadraticCurveTo(-15, 45, -20, 35); ctx.moveTo(0, 45); ctx.quadraticCurveTo(15, 45, 20, 35); ctx.stroke();
        }
        
        // Collar
        ctx.fillStyle = '#d32f2f'; ctx.fillRect(-35, 55, 70, 10);
        ctx.fillStyle = '#ffeb3b'; ctx.beginPath(); ctx.arc(0, 65, 6, 0, Math.PI*2); ctx.fill();
        ctx.restore();
    }

    document.getElementById('init-btn').addEventListener('click', () => {
        document.getElementById('overlay').style.display = 'none';
        resize(); // Resize once overlay gone
        audio.init(); loop();
    });
</script>
</body>
</html>
