<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Talking Dog: Deluxe Shop Edition</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@700&display=swap');

        /* --- GLOBAL RESET --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            margin: 0; background: #2d3436; font-family: 'Nunito', sans-serif;
            overflow: hidden; touch-action: none;
        }

        /* --- MAIN LAYOUT --- */
        #app {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; background: #fff;
        }

        /* --- HEADER (Stats & Coins) --- */
        #header {
            height: 85px; padding: 10px 15px; background: rgba(255,255,255,0.95);
            display: flex; align-items: center; gap: 10px; z-index: 10;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        
        .stats-group { flex: 1; display: flex; flex-direction: column; gap: 6px; }
        .stat-row { display: flex; align-items: center; gap: 8px; }
        .stat-icon { font-size: 14px; width: 20px; }
        .bar-bg { flex: 1; height: 10px; background: #dfe6e9; border-radius: 5px; overflow: hidden; }
        .bar-fill { height: 100%; transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); }

        /* Coin Display */
        #coin-display {
            background: #ffeaa7; color: #d35400; padding: 8px 15px;
            border-radius: 20px; font-weight: 800; font-size: 18px;
            display: flex; align-items: center; gap: 5px;
            border: 2px solid #fdcb6e; box-shadow: 0 4px 0 #fdcb6e;
        }

        /* --- GAME AREA --- */
        #canvas-wrapper { flex-grow: 1; position: relative; overflow: hidden; }
        canvas { width: 100%; height: 100%; display: block; }

        /* --- FOOTER (Actions) --- */
        #footer {
            height: 95px; background: white;
            display: flex; justify-content: space-evenly; align-items: center;
            border-radius: 30px 30px 0 0; box-shadow: 0 -5px 30px rgba(0,0,0,0.05);
            padding-bottom: env(safe-area-inset-bottom, 10px); z-index: 20;
        }

        .btn {
            width: 55px; height: 55px; border-radius: 18px; border: none;
            background: #f1f2f6; font-size: 26px; cursor: pointer;
            box-shadow: 0 4px 0 #bdc3c7; transition: transform 0.1s;
            position: relative;
        }
        .btn:active { transform: translateY(4px); box-shadow: none; }
        
        /* Special Buttons */
        #mic-btn {
            width: 75px; height: 75px; border-radius: 50%; background: #ff7675;
            color: white; font-size: 32px; margin-top: -35px;
            box-shadow: 0 6px 0 #d63031, 0 10px 20px rgba(255, 118, 117, 0.4);
        }
        #mic-btn.recording { animation: pulse 1s infinite; background: #ff3f34; }
        #shop-btn { background: #a29bfe; color: white; box-shadow: 0 4px 0 #6c5ce7; }

        /* --- SHOP MODAL --- */
        #shop-modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #f5f6fa; z-index: 50; display: none;
            flex-direction: column; padding: 20px;
        }
        #shop-modal.open { display: flex; }
        
        .shop-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .shop-title { font-family: 'Fredoka One'; font-size: 28px; color: #2d3436; margin: 0; }
        .close-btn { background: #ff7675; color: white; border: none; padding: 8px 15px; border-radius: 10px; font-weight: bold; cursor: pointer; }

        .shop-grid {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;
            overflow-y: auto; padding-bottom: 20px;
        }
        
        .shop-item {
            background: white; border-radius: 15px; padding: 15px;
            text-align: center; border: 2px solid #dfe6e9;
            cursor: pointer; transition: all 0.2s;
        }
        .shop-item.owned { border-color: #55efc4; background: #f0fff4; }
        .shop-item.equipped { border-color: #00b894; box-shadow: 0 0 0 4px rgba(0, 184, 148, 0.2); }
        
        .item-icon { font-size: 30px; margin-bottom: 5px; }
        .item-name { font-weight: bold; font-size: 14px; color: #2d3436; margin-bottom: 5px; }
        .item-price { font-size: 12px; color: #d35400; font-weight: bold; background: #ffeaa7; padding: 2px 8px; border-radius: 10px; display: inline-block;}

        /* --- START OVERLAY --- */
        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(45, 52, 54, 0.95); z-index: 100;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white; text-align: center;
        }
        .start-btn {
            background: #00b894; color: white; border: none; padding: 15px 40px;
            font-size: 22px; border-radius: 50px; font-weight: bold; margin-top: 20px;
            box-shadow: 0 5px 0 #008f72; cursor: pointer;
        }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

<div id="app">
    <!-- UI HEADER -->
    <div id="header">
        <div class="stats-group">
            <div class="stat-row">
                <span class="stat-icon">üçó</span>
                <div class="bar-bg"><div class="bar-fill" id="bar-hunger" style="background:#fdcb6e; width:80%"></div></div>
            </div>
            <div class="stat-row">
                <span class="stat-icon">üöø</span>
                <div class="bar-bg"><div class="bar-fill" id="bar-clean" style="background:#74b9ff; width:60%"></div></div>
            </div>
            <div class="stat-row">
                <span class="stat-icon">‚ö°</span>
                <div class="bar-bg"><div class="bar-fill" id="bar-energy" style="background:#55efc4; width:90%"></div></div>
            </div>
        </div>
        <div id="coin-display">
            <span>ü™ô</span><span id="coin-count">100</span>
        </div>
    </div>

    <!-- CANVAS WRAPPER -->
    <div id="canvas-wrapper">
        <canvas id="stage"></canvas>
    </div>

    <!-- FOOTER CONTROLS -->
    <div id="footer">
        <button class="btn" onclick="game.action('feed')">ü•©</button>
        <button class="btn" onclick="game.action('clean')">üöø</button>
        <button class="btn" id="mic-btn">üéôÔ∏è</button>
        <button class="btn" onclick="game.spawnBall()">üéæ</button>
        <button class="btn" id="shop-btn" onclick="shop.toggle()">üõçÔ∏è</button>
    </div>

    <!-- SHOP MODAL -->
    <div id="shop-modal">
        <div class="shop-header">
            <h2 class="shop-title">Pet Shop</h2>
            <button class="close-btn" onclick="shop.toggle()">Close</button>
        </div>
        <div class="shop-grid" id="shop-items">
            <!-- Items injected by JS -->
        </div>
    </div>

    <!-- START SCREEN -->
    <div id="start-screen">
        <h1 style="font-family:'Fredoka One'; font-size:36px; color:#ffeaa7; margin-bottom:5px;">TALKING DOG</h1>
        <p style="font-size:18px; color:#bdc3c7;">Deluxe Edition</p>
        <button class="start-btn" id="start-btn">PLAY NOW</button>
    </div>
</div>

<script>
    /* =========================================
       1. DATA & CONFIG
       ========================================= */
    const SHOP_DATA = [
        // Skins
        { id: 'skin_brown', type: 'skin', name: 'Classic Brown', price: 0, color: '#8d6e63', icon: 'üêï' },
        { id: 'skin_black', type: 'skin', name: 'Midnight', price: 100, color: '#2d3436', icon: 'üêà‚Äç‚¨õ' },
        { id: 'skin_gold', type: 'skin', name: 'Golden Retriever', price: 250, color: '#f1c40f', icon: 'ü¶Æ' },
        { id: 'skin_pink', type: 'skin', name: 'Candy Floss', price: 500, color: '#fd79a8', icon: 'üê©' },
        // Hats
        { id: 'hat_none', type: 'hat', name: 'No Hat', price: 0, icon: 'üö´' },
        { id: 'hat_cap', type: 'hat', name: 'Red Cap', price: 150, icon: 'üß¢' },
        { id: 'hat_top', type: 'hat', name: 'Gentleman', price: 300, icon: 'üé©' },
        { id: 'hat_glasses', type: 'hat', name: 'Cool Shades', price: 200, icon: 'üï∂Ô∏è' }
    ];

    /* =========================================
       2. AUDIO ENGINE
       ========================================= */
    class AudioSys {
        constructor() { this.ctx = null; }
        async init() {
            if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)();
            if (this.ctx.state === 'suspended') await this.ctx.resume();
        }
        playTone(freq, type='sine') {
            if(!this.ctx) return;
            const o = this.ctx.createOscillator();
            const g = this.ctx.createGain();
            o.type = type; o.frequency.setValueAtTime(freq, this.ctx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.2);
            o.connect(g); g.connect(this.ctx.destination);
            o.start(); o.stop(this.ctx.currentTime + 0.2);
        }
        playVoice(buffer) {
            if(!this.ctx) return;
            const src = this.ctx.createBufferSource();
            src.buffer = buffer;
            src.playbackRate.value = 0.85; 
            src.connect(this.ctx.destination);
            src.start();
            return src;
        }
    }

    /* =========================================
       3. SHOP SYSTEM
       ========================================= */
    const shop = {
        inventory: ['skin_brown', 'hat_none'], // IDs of owned items
        equipped: { skin: '#8d6e63', hat: 'hat_none' },
        
        init() {
            this.render();
        },
        
        toggle() {
            const modal = document.getElementById('shop-modal');
            modal.classList.toggle('open');
            if(modal.classList.contains('open')) this.render();
        },

        buy(itemId) {
            const item = SHOP_DATA.find(i => i.id === itemId);
            if(this.inventory.includes(itemId)) {
                this.equip(item);
            } else {
                if(game.coins >= item.price) {
                    game.coins -= item.price;
                    this.inventory.push(itemId);
                    game.updateUI();
                    audio.playTone(600, 'square'); // Buy sound
                    this.equip(item);
                    this.render();
                } else {
                    audio.playTone(150, 'sawtooth'); // Error sound
                    alert("Not enough coins!");
                }
            }
        },

        equip(item) {
            if(item.type === 'skin') this.equipped.skin = item.color;
            if(item.type === 'hat') this.equipped.hat = item.id;
            this.render();
        },

        render() {
            const grid = document.getElementById('shop-items');
            grid.innerHTML = '';
            SHOP_DATA.forEach(item => {
                const owned = this.inventory.includes(item.id);
                const isEquipped = (item.type === 'skin' && this.equipped.skin === item.color) || 
                                   (item.type === 'hat' && this.equipped.hat === item.id);
                
                const div = document.createElement('div');
                div.className = `shop-item ${owned ? 'owned' : ''} ${isEquipped ? 'equipped' : ''}`;
                div.onclick = () => this.buy(item.id);
                div.innerHTML = `
                    <div class="item-icon">${item.icon}</div>
                    <div class="item-name">${item.name}</div>
                    <div class="item-price">${owned ? (isEquipped ? 'Equipped' : 'Equip') : 'ü™ô ' + item.price}</div>
                `;
                grid.appendChild(div);
            });
        }
    };

    /* =========================================
       4. GAME ENGINE
       ========================================= */
    const canvas = document.getElementById('stage');
    const ctx = canvas.getContext('2d');
    const audio = new AudioSys();

    class Ball {
        constructor(x, y) {
            this.x = x; this.y = y; this.vx = (Math.random()-0.5)*15; this.vy = -15;
            this.active = true;
        }
        update(floor) {
            this.vy += 0.8; this.x += this.vx; this.y += this.vy;
            if(this.y > floor-15) { this.y = floor-15; this.vy *= -0.7; this.vx *= 0.95; }
            if(this.x < 0 || this.x > canvas.width) this.vx *= -1;
            if(Math.abs(this.vy) < 1 && this.y > floor-20) this.active = false;
        }
        draw() {
            ctx.fillStyle = '#badc58'; ctx.beginPath(); ctx.arc(this.x, this.y, 15, 0, Math.PI*2); ctx.fill();
            ctx.strokeStyle='white'; ctx.lineWidth=2; ctx.stroke();
        }
    }

    const game = {
        coins: 100,
        stats: { hunger: 80, clean: 80, energy: 80 },
        anim: { state: 'idle', timer: 0 },
        particles: [],
        floater: [], // Floating text (coins)
        ball: null,
        frame: 0,
        mouse: { x: 0, y: 0 },
        talking: false,

        action(type) {
            if(type === 'feed') {
                this.stats.hunger = Math.min(100, this.stats.hunger + 30);
                this.anim.state = 'eat'; this.anim.timer = 60;
                this.addCoins(10, 'üçó');
                this.spawnPart(canvas.width/2, canvas.height/2, 'ü¶¥');
            }
            if(type === 'clean') {
                this.stats.clean = 100;
                this.anim.state = 'happy'; this.anim.timer = 60;
                this.addCoins(15, '‚ú®');
                audio.playTone(400, 'sine');
            }
            this.updateUI();
        },
        
        spawnBall() {
            if(this.stats.energy > 10) {
                this.ball = new Ball(canvas.width/2, canvas.height/2);
                this.stats.energy -= 10;
                this.addCoins(5, 'üéæ');
                this.updateUI();
            }
        },

        addCoins(amount, icon) {
            this.coins += amount;
            this.floater.push({ x: canvas.width/2, y: canvas.height/2 - 50, text: `+${amount}`, life: 1 });
            this.updateUI();
        },

        spawnPart(x, y, char) {
            for(let i=0; i<6; i++) this.particles.push({x, y, char, vx:(Math.random()-0.5)*10, vy:(Math.random()-1)*10, life:1});
        },

        updateUI() {
            document.getElementById('bar-hunger').style.width = this.stats.hunger + '%';
            document.getElementById('bar-clean').style.width = this.stats.clean + '%';
            document.getElementById('bar-energy').style.width = this.stats.energy + '%';
            document.getElementById('coin-count').innerText = this.coins;
        }
    };

    /* =========================================
       5. INPUTS & RENDERING
       ========================================= */
    function resize() {
        canvas.width = document.getElementById('canvas-wrapper').offsetWidth;
        canvas.height = document.getElementById('canvas-wrapper').offsetHeight;
    }
    window.addEventListener('resize', resize);
    window.addEventListener('pointermove', e => {
        const r = canvas.getBoundingClientRect();
        game.mouse.x = e.clientX - r.left; game.mouse.y = e.clientY - r.top;
    });

    // Touch Interaction
    canvas.addEventListener('pointerdown', e => {
        const r = canvas.getBoundingClientRect();
        const x = e.clientX - r.left; const y = e.clientY - r.top;
        const cy = canvas.height/2;

        if(game.ball) { game.ball.vy = -20; game.ball.vx = (Math.random()-0.5)*20; return; }

        audio.init();
        if(y < cy) { 
            game.anim.state = 'happy'; game.anim.timer = 30; 
            game.spawnPart(x, y, '‚ù§Ô∏è'); 
            audio.playTone(600, 'sine');
        } else {
            game.spawnPart(x, y, '‚úã');
        }
    });

    // Mic
    const micBtn = document.getElementById('mic-btn');
    let mediaRecorder, chunks = [];
    const startRec = async (e) => {
        if(e) e.preventDefault(); await audio.init();
        try {
            const stream = await navigator.mediaDevices.getUserMedia({audio:true});
            mediaRecorder = new MediaRecorder(stream);
            chunks=[]; mediaRecorder.ondataavailable=e=>chunks.push(e.data);
            mediaRecorder.start(); micBtn.classList.add('recording');
        } catch(e){ alert("Mic Access Needed"); }
    };
    const stopRec = (e) => {
        if(e) e.preventDefault();
        if(!mediaRecorder || mediaRecorder.state==='inactive') return;
        mediaRecorder.stop(); micBtn.classList.remove('recording');
        mediaRecorder.onstop = async () => {
            const blob = new Blob(chunks, {'type':'audio/ogg; codecs=opus'});
            const buf = await audio.ctx.decodeAudioData(await blob.arrayBuffer());
            const src = audio.playVoice(buf);
            game.talking = true; src.onended = () => game.talking = false;
        };
    };
    micBtn.addEventListener('mousedown', startRec); micBtn.addEventListener('touchstart', startRec);
    micBtn.addEventListener('mouseup', stopRec); micBtn.addEventListener('touchend', stopRec);

    /* --- DRAW LOOP --- */
    function loop() {
        game.frame++;
        if(game.frame%300===0) {
            game.stats.hunger = Math.max(0, game.stats.hunger-2);
            game.stats.clean = Math.max(0, game.stats.clean-1);
            game.stats.energy = Math.max(0, game.stats.energy-1);
            game.updateUI();
        }
        if(game.anim.timer > 0) { game.anim.timer--; if(game.anim.timer<=0) game.anim.state='idle'; }

        // Draw BG
        let floorY = canvas.height * 0.7;
        ctx.fillStyle = '#a8e6cf'; ctx.fillRect(0,0,canvas.width, canvas.height); // Wall
        ctx.fillStyle = 'rgba(0,0,0,0.1)'; ctx.fillRect(0, floorY, canvas.width, canvas.height-floorY); // Floor

        // Draw Ball
        if(game.ball) { game.ball.update(floorY + 80); game.ball.draw(); }

        drawDog(floorY);

        // Draw Particles
        for(let i=game.particles.length-1; i>=0; i--) {
            let p = game.particles[i]; p.x+=p.vx; p.y+=p.vy; p.vy+=0.5; p.life-=0.05;
            ctx.globalAlpha=p.life; ctx.font="24px Arial"; ctx.fillText(p.char, p.x, p.y);
            ctx.globalAlpha=1; if(p.life<=0) game.particles.splice(i,1);
        }
        // Draw Floating Text
        for(let i=game.floater.length-1; i>=0; i--) {
            let f = game.floater[i]; f.y-=2; f.life-=0.02;
            ctx.globalAlpha=f.life; ctx.fillStyle="#d35400"; ctx.font="bold 30px Arial"; 
            ctx.fillText(f.text + "ü™ô", f.x, f.y);
            ctx.globalAlpha=1; if(f.life<=0) game.floater.splice(i,1);
        }
        // Flies
        if(game.stats.clean < 40) ctx.fillText("ü™∞", canvas.width/2 - 70, floorY-100);

        requestAnimationFrame(loop);
    }

    function drawDog(floorY) {
        const cx = canvas.width/2;
        const cy = floorY - 20;
        let breath = Math.sin(game.frame*0.08)*3;
        
        ctx.save();
        ctx.translate(cx, cy);

        // Tail
        ctx.beginPath(); ctx.strokeStyle = shop.equipped.skin; ctx.lineWidth = 15; ctx.lineCap = 'round';
        let wag = Math.cos(game.frame * (game.anim.state==='happy'?0.5:0.1)) * 30;
        ctx.moveTo(40, 30); ctx.quadraticCurveTo(70, 10, 70+wag, -30); ctx.stroke();

        // Body
        ctx.fillStyle = shop.equipped.skin;
        ctx.beginPath(); ctx.ellipse(0, 40, 65, 75+breath, 0, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = 'rgba(255,255,255,0.4)'; // Belly Highlight
        ctx.beginPath(); ctx.ellipse(0, 50, 35, 45+breath, 0, 0, Math.PI*2); ctx.fill();

        // HEAD GROUP
        ctx.translate(0, -60+breath);
        
        // Ears
        ctx.fillStyle = shop.equipped.skin; 
        // Darken ears slightly logic omitted for simplicity, using same color
        ctx.beginPath(); ctx.moveTo(-50, -30); ctx.bezierCurveTo(-90, -10, -80, 60, -50, 40); ctx.fill();
        ctx.beginPath(); ctx.moveTo(50, -30); ctx.bezierCurveTo(90, -10, 80, 60, 50, 40); ctx.fill();

        // Head Circle
        ctx.beginPath(); ctx.arc(0, 0, 65, 0, Math.PI*2); ctx.fill();

        // Snout
        ctx.fillStyle = '#f5f6fa'; ctx.beginPath(); ctx.ellipse(0, 20, 35, 28, 0, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = '#2d3436'; ctx.beginPath(); ctx.arc(0, 10, 12, 0, Math.PI*2); ctx.fill(); // Nose

        // Eyes (Tracking)
        let tx = game.ball ? game.ball.x : game.mouse.x;
        let ty = game.ball ? game.ball.y : game.mouse.y;
        let dx = (tx - cx)/20; let dy = (ty - (cy-60))/20;
        dx = Math.max(-10, Math.min(10, dx));
        
        ctx.fillStyle = 'white';
        ctx.beginPath(); ctx.ellipse(-25, -20, 14, 14, 0, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.ellipse(25, -20, 14, 14, 0, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = 'black';
        ctx.beginPath(); ctx.arc(-25+dx, -20+dy, 6, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(25+dx, -20+dy, 6, 0, Math.PI*2); ctx.fill();

        // Mouth
        ctx.fillStyle = '#ff7675';
        if(game.talking || game.anim.state==='happy') {
            ctx.beginPath(); ctx.arc(0, 30, 15, 0, Math.PI); ctx.fill();
        } else {
            ctx.beginPath(); ctx.strokeStyle='#2d3436'; ctx.lineWidth=3;
            ctx.moveTo(0,35); ctx.lineTo(0,45); 
            ctx.moveTo(0,45); ctx.quadraticCurveTo(-15,45,-20,35);
            ctx.moveTo(0,45); ctx.quadraticCurveTo(15,45,20,35); ctx.stroke();
        }

        // --- HATS DRAWING ---
        if(shop.equipped.hat === 'hat_cap') {
            ctx.fillStyle = '#d63031';
            ctx.beginPath(); ctx.arc(0, -50, 66, Math.PI, 0); ctx.fill(); // Dome
            ctx.fillRect(-70, -50, 140, 10); // Brim
        }
        if(shop.equipped.hat === 'hat_top') {
            ctx.fillStyle = '#2d3436';
            ctx.fillRect(-40, -100, 80, 60); // Top
            ctx.fillRect(-60, -40, 120, 10); // Brim
            ctx.fillStyle = '#d63031'; ctx.fillRect(-40, -50, 80, 10); // Stripe
        }
        if(shop.equipped.hat === 'hat_glasses') {
            ctx.fillStyle = 'rgba(0,0,0,0.8)';
            ctx.fillRect(-50, -30, 45, 20); ctx.fillRect(5, -30, 45, 20);
            ctx.strokeStyle = '#2d3436'; ctx.lineWidth=2;
            ctx.beginPath(); ctx.moveTo(-5, -20); ctx.lineTo(5, -20); ctx.stroke();
        }

        // Collar
        ctx.fillStyle = '#d63031'; ctx.fillRect(-35, 55, 70, 10);
        ctx.fillStyle = '#f1c40f'; ctx.beginPath(); ctx.arc(0, 65, 6, 0, Math.PI*2); ctx.fill();

        ctx.restore();
    }

    // Init
    document.getElementById('start-btn').addEventListener('click', () => {
        document.getElementById('start-screen').style.display = 'none';
        shop.init(); resize(); audio.init(); loop();
    });

</script>
</body>
</html>
