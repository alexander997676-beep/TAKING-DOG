<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Talking Dog: Ultimate Edition</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&family=Varela+Round&display=swap');

        :root {
            --primary: #FF6B6B;
            --secondary: #4ECDC4;
            --accent: #FFE66D;
            --dark: #2C3E50;
            --ui-bg: rgba(255, 255, 255, 0.95);
        }

        body {
            margin: 0;
            overflow: hidden;
            background: #2C3E50;
            font-family: 'Varela Round', sans-serif;
            touch-action: none; /* Prevents pull-to-refresh on mobile */
            user-select: none;
            -webkit-user-select: none;
        }

        #game-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, #4facfe 0%, #00f2fe 100%);
            transition: background 1s ease;
        }

        canvas { display: block; width: 100%; height: 100%; }

        /* UI OVERLAY */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; /* Let clicks pass through to canvas */
            display: flex; flex-direction: column; justify-content: space-between;
        }

        .hud-top {
            padding: 15px;
            display: flex; justify-content: space-between;
            align-items: flex-start;
            pointer-events: auto;
        }

        .stat-badge {
            background: var(--ui-bg); padding: 8px 15px; border-radius: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            font-family: 'Fredoka One', cursive; color: var(--dark);
            display: flex; align-items: center; gap: 8px; font-size: 18px;
            border: 3px solid white;
        }

        .btn-icon {
            width: 45px; height: 45px; border-radius: 50%; border: none;
            background: white; font-size: 22px; cursor: pointer;
            box-shadow: 0 4px 0 #bdc3c7; transition: transform 0.1s;
            margin-left: 10px; pointer-events: auto;
        }
        .btn-icon:active { transform: translateY(4px); box-shadow: none; }

        /* BARS */
        .bars-wrapper {
            position: absolute; top: 70px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; display: flex; gap: 8px;
            pointer-events: none;
        }
        .bar-pill {
            flex: 1; height: 12px; background: rgba(0,0,0,0.3);
            border-radius: 6px; overflow: hidden; border: 2px solid rgba(255,255,255,0.5);
        }
        .bar-fill { height: 100%; width: 100%; transition: width 0.5s ease; }

        /* FOOTER CONTROLS */
        .controls-area {
            background: var(--ui-bg);
            border-radius: 30px 30px 0 0;
            padding: 20px 20px 30px 20px;
            display: flex; justify-content: space-around; align-items: flex-end;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.1);
            pointer-events: auto;
            position: relative;
        }

        .action-btn {
            width: 60px; height: 60px; border-radius: 20px;
            border: none; background: #f1f2f6; font-size: 28px;
            box-shadow: 0 6px 0 #dcdde1; cursor: pointer;
            transition: all 0.1s; position: relative;
        }
        .action-btn:active { transform: translateY(6px); box-shadow: 0 0 0; }
        .action-btn span { display: block; font-size: 10px; font-weight: bold; color: #7f8c8d; margin-top: -5px; }

        #mic-trigger {
            width: 85px; height: 85px; border-radius: 50%;
            background: var(--primary); color: white;
            font-size: 40px; border: 6px solid white;
            margin-bottom: 15px;
            box-shadow: 0 10px 20px rgba(255, 107, 107, 0.4);
            display: flex; align-items: center; justify-content: center;
            animation: float 3s ease-in-out infinite;
        }
        #mic-trigger.recording { background: #ff4757; animation: pulse 0.8s infinite; }

        /* SHOP & MINIGAME OVERLAYS */
        .overlay {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 80%;
            background: white; border-radius: 40px 40px 0 0;
            transform: translateY(110%); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 100; display: flex; flex-direction: column;
            box-shadow: 0 -100px 0 rgba(0,0,0,0.5); /* Dim background */
            pointer-events: auto;
        }
        .overlay.open { transform: translateY(0); }
        .overlay-header { padding: 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; }
        .overlay-content { flex: 1; overflow-y: auto; padding: 20px; }
        
        .shop-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .shop-item {
            background: #f8f9fa; border-radius: 15px; padding: 15px 5px;
            text-align: center; border: 2px solid transparent; cursor: pointer;
        }
        .shop-item.active { border-color: var(--secondary); background: #e0fbfc; }

        /* TOAST NOTIFICATION */
        #toast {
            position: absolute; top: 100px; left: 50%; transform: translateX(-50%) translateY(-20px);
            background: #2d3436; color: white; padding: 10px 20px; border-radius: 50px;
            font-weight: bold; opacity: 0; transition: 0.3s; pointer-events: none;
        }
        #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
    </style>
</head>
<body>

<div id="game-layer">
    <canvas id="cvs"></canvas>
</div>

<div id="ui-layer">
    <!-- Top HUD -->
    <div class="hud-top">
        <div class="stat-badge">ü™ô <span id="coin-display">100</span></div>
        <div style="display:flex;">
            <button class="btn-icon" onclick="game.startMinigame()">üéÆ</button>
            <button class="btn-icon" onclick="shop.toggle()">üëï</button>
        </div>
    </div>

    <!-- Bars -->
    <div class="bars-wrapper">
        <div class="bar-pill"><div class="bar-fill" id="fill-food" style="background:#ff9ff3;"></div></div>
        <div class="bar-pill"><div class="bar-fill" id="fill-clean" style="background:#54a0ff;"></div></div>
        <div class="bar-pill"><div class="bar-fill" id="fill-sleep" style="background:#00d2d3;"></div></div>
    </div>

    <!-- Toast -->
    <div id="toast">Signal</div>

    <!-- Controls -->
    <div class="controls-area" id="main-controls">
        <button class="action-btn" onclick="game.interact('food')">üçó<br><span>EAT</span></button>
        <button class="action-btn" onclick="game.interact('clean')">üßº<br><span>WASH</span></button>
        
        <div id="mic-trigger">üéôÔ∏è</div>
        
        <button class="action-btn" onclick="game.spawnToy()">üéæ<br><span>PLAY</span></button>
        <button class="action-btn" onclick="game.toggleSleep()">üí§<br><span>SLEEP</span></button>
    </div>
</div>

<!-- SHOP OVERLAY -->
<div class="overlay" id="shop-overlay">
    <div class="overlay-header">
        <h2 style="margin:0; font-family:'Fredoka One'">Wardrobe</h2>
        <button class="btn-icon" onclick="shop.toggle()">‚úï</button>
    </div>
    <div class="overlay-content">
        <div class="shop-grid" id="shop-grid"></div>
    </div>
</div>

<!-- MINIGAME OVERLAY (Canvas takeover logic) -->
<div id="minigame-ui" style="display:none; position:absolute; top:20px; width:100%; text-align:center; pointer-events:none;">
    <h1 style="color:white; font-family:'Fredoka One'; text-shadow:2px 2px 0 #000;">CATCH THE BONES!</h1>
    <h2 style="color:#FFE66D; font-family:'Fredoka One'; text-shadow:2px 2px 0 #000;">Score: <span id="mg-score">0</span></h2>
    <button onclick="game.endMinigame()" style="pointer-events:auto; padding:10px 20px; border-radius:20px; border:none; background:#ff6b6b; color:white; font-weight:bold; margin-top:10px;">EXIT</button>
</div>

<script>
    /* =========================================
       AUDIO ENGINE (Web Audio API)
       Generates sounds synthetically to avoid external assets
       ========================================= */
    const SFX = {
        ctx: null,
        init() {
            window.AudioContext = window.AudioContext || window.webkitAudioContext;
            this.ctx = new AudioContext();
        },
        play(type) {
            if (!this.ctx) this.init();
            if (this.ctx.state === 'suspended') this.ctx.resume();
            
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.connect(gain);
            gain.connect(this.ctx.destination);

            const now = this.ctx.currentTime;
            
            if (type === 'coin') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(1200, now);
                osc.frequency.exponentialRampToValueAtTime(2000, now + 0.1);
                gain.gain.setValueAtTime(0.3, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                osc.start(now); osc.stop(now + 0.3);
            } else if (type === 'pop') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(400, now);
                gain.gain.setValueAtTime(0.2, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.start(now); osc.stop(now + 0.1);
            } else if (type === 'bark') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(300, now);
                osc.frequency.linearRampToValueAtTime(100, now + 0.15);
                gain.gain.setValueAtTime(0.3, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
                osc.start(now); osc.stop(now + 0.15);
            }
        },
        playVoice(buffer) {
            if (!this.ctx) this.init();
            const src = this.ctx.createBufferSource();
            src.buffer = buffer;
            src.playbackRate.value = 1.35; // Pitch shift up
            src.connect(this.ctx.destination);
            src.start();
            return src;
        }
    };

    /* =========================================
       GAME ENGINE & STATE
       ========================================= */
    const canvas = document.getElementById('cvs');
    const ctx = canvas.getContext('2d');
    let W, H;

    const game = {
        state: 'IDLE', // IDLE, SLEEP, TALK, MINIGAME
        coins: 150,
        stats: { food: 80, clean: 60, sleep: 90 },
        dog: {
            x: 0, y: 0, 
            scaleY: 1, scaleX: 1,
            eyeX: 0, eyeY: 0,
            blinkTimer: 0,
            animTimer: 0,
            emotion: 'neutral' // happy, neutral, sad
        },
        particles: [],
        minigame: { items: [], score: 0, playerX: 0 },
        toy: null,
        
        init() {
            this.resize();
            window.addEventListener('resize', () => this.resize());
            this.loop();
            setInterval(() => this.decayStats(), 5000);
        },

        resize() {
            W = window.innerWidth; H = window.innerHeight;
            canvas.width = W * window.devicePixelRatio;
            canvas.height = H * window.devicePixelRatio;
            ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
            this.dog.x = W / 2;
            this.dog.y = H * 0.65;
        },

        decayStats() {
            if (this.state === 'MINIGAME') return;
            if (this.state !== 'SLEEP') this.stats.sleep = Math.max(0, this.stats.sleep - 1);
            this.stats.food = Math.max(0, this.stats.food - 1);
            this.stats.clean = Math.max(0, this.stats.clean - 0.5);
            this.updateUI();
        },

        interact(type) {
            if (this.state === 'SLEEP' && type !== 'sleep') {
                this.toast("Shhh! Dog is sleeping!");
                return;
            }

            if (type === 'food') {
                if (this.stats.food >= 100) return this.toast("Not hungry!");
                this.stats.food = Math.min(100, this.stats.food + 25);
                this.spawnParticles(this.dog.x, this.dog.y - 50, 'üçó', 5);
                this.animDog('eat');
            } else if (type === 'clean') {
                this.stats.clean = 100;
                this.spawnParticles(this.dog.x, this.dog.y - 50, 'ü´ß', 8);
                this.animDog('happy');
            }
            SFX.play('pop');
            this.updateUI();
        },

        toggleSleep() {
            if (this.state === 'SLEEP') {
                this.state = 'IDLE';
                document.getElementById('game-layer').style.background = 'linear-gradient(to bottom, #4facfe 0%, #00f2fe 100%)';
                this.animDog('happy');
            } else {
                this.state = 'SLEEP';
                document.getElementById('game-layer').style.background = 'linear-gradient(to bottom, #0f2027, #203a43, #2c5364)';
                this.animDog('sleep');
            }
            this.updateUI();
        },

        spawnToy() {
            if(this.toy) return;
            this.toy = { x: W/2, y: -50, vx: (Math.random()-0.5)*10, vy: 0, r: 25 };
            this.animDog('happy');
        },

        spawnParticles(x, y, char, count) {
            for(let i=0; i<count; i++) {
                this.particles.push({
                    x, y, char,
                    vx: (Math.random()-0.5)*10,
                    vy: (Math.random()-1)*15,
                    life: 1.0
                });
            }
        },

        animDog(type) {
            this.dog.scaleY = 0.8; // Squash
            this.dog.scaleX = 1.2;
            setTimeout(() => {
                this.dog.scaleY = 1.1; // Stretch
                this.dog.scaleX = 0.9; 
            }, 100);
            
            if (type === 'happy') this.dog.emotion = 'happy';
            if (type === 'eat') this.dog.emotion = 'happy';
            
            clearTimeout(this.animTimer);
            this.animTimer = setTimeout(() => {
                this.dog.emotion = 'neutral';
                this.dog.scaleY = 1; this.dog.scaleX = 1;
            }, 1000);
        },

        updateUI() {
            document.getElementById('coin-display').innerText = this.coins;
            document.getElementById('fill-food').style.width = this.stats.food + '%';
            document.getElementById('fill-clean').style.width = this.stats.clean + '%';
            document.getElementById('fill-sleep').style.width = this.stats.sleep + '%';
            
            // Color feedback
            document.getElementById('fill-food').style.background = this.stats.food < 30 ? '#ff7675' : '#ff9ff3';
        },

        toast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        },

        // MINIGAME LOGIC
        startMinigame() {
            this.state = 'MINIGAME';
            this.minigame.score = 0;
            this.minigame.items = [];
            this.minigame.playerX = W/2;
            document.getElementById('main-controls').style.display = 'none';
            document.getElementById('minigame-ui').style.display = 'block';
            document.getElementById('mg-score').innerText = '0';
        },
        endMinigame() {
            this.state = 'IDLE';
            document.getElementById('main-controls').style.display = 'flex';
            document.getElementById('minigame-ui').style.display = 'none';
            this.coins += this.minigame.score;
            this.updateUI();
            this.toast(`Earned +${this.minigame.score} Coins!`);
        },

        loop() {
            ctx.clearRect(0,0,W,H);
            
            if (this.state === 'MINIGAME') {
                this.renderMinigame();
            } else {
                this.renderMainGame();
            }
            requestAnimationFrame(() => this.loop());
        },

        renderMainGame() {
            // Environment (Clouds)
            const time = Date.now() / 1000;
            ctx.fillStyle = 'rgba(255,255,255,0.2)';
            ctx.beginPath(); ctx.arc(W*0.2 + Math.sin(time/5)*50, H*0.2, 40, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(W*0.8 + Math.sin(time/8)*40, H*0.15, 60, 0, Math.PI*2); ctx.fill();

            // Toy Physics
            if(this.toy) {
                this.toy.vy += 0.8; 
                this.toy.x += this.toy.vx; 
                this.toy.y += this.toy.vy;
                
                // Bounce floor
                if(this.toy.y > H - 150) { 
                    this.toy.y = H - 150; 
                    this.toy.vy *= -0.6; 
                    this.toy.vx *= 0.9; // Friction
                }
                // Bounce walls
                if(this.toy.x < 0 || this.toy.x > W) this.toy.vx *= -1;

                if(Math.abs(this.toy.vy) < 0.5 && Math.abs(this.toy.vx) < 0.5 && this.toy.y > H - 160) this.toy = null; // Remove stopped toy

                if(this.toy) {
                    ctx.save(); ctx.translate(this.toy.x, this.toy.y);
                    ctx.fillStyle = '#badc58'; ctx.beginPath(); ctx.arc(0,0,25,0,Math.PI*2); ctx.fill();
                    ctx.strokeStyle = 'white'; ctx.lineWidth=3; ctx.beginPath(); 
                    ctx.arc(0,0,25,0,Math.PI*2); ctx.moveTo(-15,0); ctx.lineTo(15,0); ctx.stroke();
                    ctx.restore();
                }
            }

            // Dog Drawing
            drawDog(W/2, this.dog.y, this.dog);

            // Particles
            for(let i=this.particles.length-1; i>=0; i--) {
                let p = this.particles[i];
                p.x += p.vx; p.y += p.vy; p.vy += 0.5; p.life -= 0.02;
                ctx.globalAlpha = Math.max(0, p.life);
                ctx.font = '30px Arial'; ctx.fillText(p.char, p.x, p.y);
                ctx.globalAlpha = 1;
                if(p.life <= 0) this.particles.splice(i, 1);
            }
        },

        renderMinigame() {
            // Player (Dog Head) follow mouse
            this.minigame.playerX += (input.x - this.minigame.playerX) * 0.2;
            
            // Draw Player
            ctx.save();
            ctx.translate(this.minigame.playerX, H - 100);
            drawHead(0, 0, 0.8, shop.skins[shop.selected].colors, false);
            ctx.restore();

            // Spawn Items
            if (Math.random() < 0.03) {
                this.minigame.items.push({
                    x: Math.random() * W, y: -50,
                    type: Math.random() > 0.3 ? 'bone' : 'bomb',
                    speed: 5 + Math.random() * 5
                });
            }

            // Update Items
            for (let i = this.minigame.items.length - 1; i >= 0; i--) {
                let item = this.minigame.items[i];
                item.y += item.speed;
                
                // Render
                ctx.font = '40px Arial';
                ctx.fillText(item.type === 'bone' ? 'üçñ' : 'üí£', item.x - 20, item.y);

                // Collision
                let dx = item.x - this.minigame.playerX;
                let dy = item.y - (H - 100);
                let dist = Math.sqrt(dx*dx + dy*dy);

                if (dist < 60) {
                    if (item.type === 'bone') {
                        this.minigame.score += 10;
                        SFX.play('coin');
                        this.spawnParticles(item.x, item.y, '‚ú®', 3);
                    } else {
                        this.minigame.score = Math.max(0, this.minigame.score - 20);
                        SFX.play('bark'); // Ouch sound substitute
                        document.getElementById('game-layer').style.background = '#ff7675';
                        setTimeout(()=>document.getElementById('game-layer').style.background = '#4facfe', 100);
                    }
                    this.minigame.items.splice(i, 1);
                    document.getElementById('mg-score').innerText = this.minigame.score;
                } else if (item.y > H) {
                    this.minigame.items.splice(i, 1);
                }
            }
        }
    };

    /* =========================================
       INPUT & INTERACTIONS
       ========================================= */
    const input = { x: W/2, y: H/2, isDown: false };
    
    // Mouse/Touch Tracking
    const updateInput = (e) => {
        const cx = e.touches ? e.touches[0].clientX : e.clientX;
        const cy = e.touches ? e.touches[0].clientY : e.clientY;
        input.x = cx; input.y = cy;
        
        // Petting Logic
        if (input.isDown && game.state === 'IDLE') {
            const dx = cx - W/2;
            const dy = cy - (game.dog.y - 100); // Head area
            if (Math.sqrt(dx*dx + dy*dy) < 80) {
                if (Math.random() > 0.9) {
                    game.spawnParticles(cx, cy, '‚ù§Ô∏è', 1);
                    game.dog.emotion = 'happy';
                    game.dog.scaleY = 0.95; // Purr effect
                }
            }
        }
    };

    window.addEventListener('pointermove', updateInput);
    window.addEventListener('pointerdown', (e) => {
        input.isDown = true;
        updateInput(e);
        SFX.init(); // Init Audio Context
    });
    window.addEventListener('pointerup', () => {
        input.isDown = false;
        game.dog.scaleY = 1;
    });

    /* =========================================
       MICROPHONE RECORDING
       ========================================= */
    const micBtn = document.getElementById('mic-trigger');
    let mediaRecorder, chunks = [];

    micBtn.addEventListener('mousedown', startRec);
    micBtn.addEventListener('touchstart', (e) => { e.preventDefault(); startRec(); });
    
    window.addEventListener('mouseup', stopRec);
    window.addEventListener('touchend', stopRec);

    async function startRec() {
        if(game.state === 'SLEEP') return game.toast("Zzz...");
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            chunks = [];
            mediaRecorder.ondataavailable = e => chunks.push(e.data);
            mediaRecorder.start();
            micBtn.classList.add('recording');
            game.dog.emotion = 'happy';
        } catch (err) {
            console.error(err);
            game.toast("Mic Access Denied");
        }
    }

    function stopRec() {
        if (!mediaRecorder || mediaRecorder.state === 'inactive') return;
        mediaRecorder.stop();
        micBtn.classList.remove('recording');
        
        mediaRecorder.onstop = async () => {
            const blob = new Blob(chunks, { 'type': 'audio/ogg; codecs=opus' });
            const arrayBuffer = await blob.arrayBuffer();
            const audioBuffer = await SFX.ctx.decodeAudioData(arrayBuffer);
            
            game.state = 'TALK';
            const source = SFX.playVoice(audioBuffer);
            source.onended = () => { game.state = 'IDLE'; };
        };
    }

    /* =========================================
       SHOP SYSTEM
       ========================================= */
    const shop = {
        selected: 0,
        skins: [
            { name: 'Beagle', colors: ['#D7CCC8', '#8D6E63'], cost: 0 },
            { name: 'Husky', colors: ['#ecf0f1', '#2c3e50'], cost: 50 },
            { name: 'Pug', colors: ['#f1c40f', '#d35400'], cost: 100 },
            { name: 'Alien', colors: ['#55efc4', '#00b894'], cost: 200 },
            { name: 'Robot', colors: ['#bdc3c7', '#7f8c8d'], cost: 300 }
        ],
        toggle() {
            const el = document.getElementById('shop-overlay');
            el.classList.toggle('open');
            this.renderShop();
        },
        renderShop() {
            const grid = document.getElementById('shop-grid');
            grid.innerHTML = '';
            this.skins.forEach((skin, idx) => {
                const div = document.createElement('div');
                div.className = `shop-item ${idx === this.selected ? 'active' : ''}`;
                div.innerHTML = `
                    <div style="width:30px;height:30px;background:${skin.colors[1]};border-radius:50%;margin:0 auto;"></div>
                    <div style="font-weight:bold;margin-top:5px;">${skin.name}</div>
                    <div style="font-size:12px;color:#777;">${idx === 0 ? 'Free' : 'ü™ô'+skin.cost}</div>
                `;
                div.onclick = () => {
                    if (game.coins >= skin.cost || idx === 0 || idx === this.selected) { // Allow re-selecting bought? (Simplified logic here)
                         // Real game would track 'owned' status. Assuming free for demo or simple deduction
                        this.selected = idx;
                        this.renderShop();
                        SFX.play('pop');
                    }
                };
                grid.appendChild(div);
            });
        }
    };

    /* =========================================
       RENDERER (Canvas Art)
       ========================================= */
    function drawHead(x, y, scale, colors, isDirty) {
        ctx.save(); ctx.translate(x, y); ctx.scale(scale, scale);
        
        // Ears
        ctx.fillStyle = colors[1];
        ctx.beginPath(); ctx.ellipse(-50, -10, 25, 50, -0.5, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.ellipse(50, -10, 25, 50, 0.5, 0, Math.PI*2); ctx.fill();

        // Face Base
        let grad = ctx.createLinearGradient(0, -60, 0, 60);
        grad.addColorStop(0, colors[0]); grad.addColorStop(1, colors[1]);
        ctx.fillStyle = grad;
        ctx.beginPath(); ctx.arc(0, 0, 65, 0, Math.PI*2); ctx.fill();

        // Snout
        ctx.fillStyle = 'rgba(255,255,255,0.4)';
        ctx.beginPath(); ctx.ellipse(0, 20, 35, 28, 0, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = '#2d3436';
        ctx.beginPath(); ctx.ellipse(0, 15, 12, 10, 0, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = 'rgba(255,255,255,0.3)';
        ctx.beginPath(); ctx.arc(-3, 12, 3, 0, Math.PI*2); ctx.fill(); // Nose Shine

        // Eyes
        let blink = game.dog.blinkTimer > 0 || game.state === 'SLEEP';
        if(game.state !== 'SLEEP' && Math.random() < 0.02) game.dog.blinkTimer = 10;
        if(game.dog.blinkTimer > 0) game.dog.blinkTimer--;

        if (blink) {
            ctx.strokeStyle = '#2d3436'; ctx.lineWidth = 4;
            ctx.beginPath(); ctx.moveTo(-35, -15); ctx.lineTo(-15, -15); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(35, -15); ctx.lineTo(15, -15); ctx.stroke();
        } else {
            ctx.fillStyle = 'white';
            ctx.beginPath(); ctx.ellipse(-25, -15, 12, 16, 0, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.ellipse(25, -15, 12, 16, 0, 0, Math.PI*2); ctx.fill();
            
            // Pupils (Track Input)
            let lx = Math.max(-5, Math.min(5, (input.x - W/2)/20));
            let ly = Math.max(-5, Math.min(5, (input.y - H*0.6)/20));
            ctx.fillStyle = '#2d3436';
            ctx.beginPath(); ctx.arc(-25+lx, -15+ly, 6, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(25+lx, -15+ly, 6, 0, Math.PI*2); ctx.fill();
        }

        // Mouth
        if (game.state === 'TALK') {
            let open = Math.sin(Date.now()/50)*10 + 10;
            ctx.fillStyle = '#fab1a0';
            ctx.beginPath(); ctx.arc(0, 40, open, 0, Math.PI); ctx.fill();
        } else if (game.dog.emotion === 'happy') {
            ctx.strokeStyle = '#2d3436'; ctx.lineWidth = 3; ctx.lineCap='round';
            ctx.beginPath(); ctx.arc(0, 35, 15, 0, Math.PI); ctx.stroke();
        } else {
            ctx.strokeStyle = '#2d3436'; ctx.lineWidth = 3; ctx.lineCap='round';
            ctx.beginPath(); ctx.moveTo(-10, 45); ctx.quadraticCurveTo(0, 40, 10, 45); ctx.stroke();
        }

        ctx.restore();
    }

    function drawDog(x, y, dog) {
        let colors = shop.skins[shop.selected].colors;
        let breath = Math.sin(Date.now() / 800) * 3;
        let isDirty = game.stats.clean < 50;
        
        // Physics Smoothing
        dog.scaleX += (1 - dog.scaleX) * 0.1;
        dog.scaleY += (1 - dog.scaleY) * 0.1;

        ctx.save();
        ctx.translate(x, y);
        ctx.scale(dog.scaleX, dog.scaleY);

        // Shadow
        ctx.fillStyle = 'rgba(0,0,0,0.2)';
        ctx.beginPath(); ctx.ellipse(0, 95, 70, 15, 0, 0, Math.PI*2); ctx.fill();

        // Tail
        let wag = (dog.emotion === 'happy' || game.state === 'TALK') ? Math.sin(Date.now()/50)*35 : Math.sin(Date.now()/500)*5;
        ctx.strokeStyle = colors[1]; ctx.lineWidth = 18; ctx.lineCap = 'round';
        ctx.beginPath(); ctx.moveTo(40, 50); ctx.quadraticCurveTo(70, 30, 75+wag, -10); ctx.stroke();

        // Body
        let grad = ctx.createLinearGradient(-40, 0, 40, 0);
        grad.addColorStop(0, colors[0]); grad.addColorStop(1, colors[1]);
        ctx.fillStyle = grad;
        
        ctx.beginPath(); 
        // Pear shape body
        ctx.moveTo(-40, 80); 
        ctx.bezierCurveTo(-50, 80, -60, 20, -20, 0);
        ctx.lineTo(20, 0);
        ctx.bezierCurveTo(60, 20, 50, 80, 40, 80);
        ctx.fill();

        // Belly Patch
        ctx.fillStyle = 'rgba(255,255,255,0.2)';
        ctx.beginPath(); ctx.ellipse(0, 55, 25, 30+breath, 0, 0, Math.PI*2); ctx.fill();

        // Mud Spots
        if (isDirty) {
            ctx.fillStyle = '#795548';
            ctx.beginPath(); ctx.arc(-30, 60, 10, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(20, 40, 8, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(0, 70, 12, 0, Math.PI*2); ctx.fill();
        }

        // Collar
        ctx.fillStyle = '#ff6b6b'; ctx.fillRect(-30, -5, 60, 10);
        ctx.fillStyle = '#feca57'; ctx.beginPath(); ctx.arc(0, 5, 8, 0, Math.PI*2); ctx.fill(); // Tag

        // Head Animation Bob
        let headY = -60 + breath;
        drawHead(0, headY, 1, colors, isDirty);

        ctx.restore();
    }

    game.init();

</script>
</body>
</html>
